# Changelog - v2.2.0

## Release Date
2025-10-30

## 重大更新 Major Updates

### 1. 表格列宽优化 - 解决数字换行问题
**问题：** 在打印视图中，NET WT. 和 QTY. 列由于宽度不足，导致大数字（如 3,000,000）换行显示。

**解决方案：**
- 减小 DESCRIPTION 列宽，为数字列腾出空间
- 增加 QTY. 和 NET WT. 列宽度
- 缩小表格字体（0.75rem → 0.7rem）

**发票表格 (Invoice Table) 列宽调整：**
| 列名 | v2.1 | v2.2 | 变化 |
|------|------|------|------|
| # | 5% | 4% | -1% |
| DESCRIPTION | 45% | 32% | -13% |
| HS CODE | 12% | 11% | -1% |
| NET WT. | 8% | 10% | +2% |
| QTY. | 8% | 12% | +4% |
| UOM | 8% | 7% | -1% |
| UNIT PRICE | 10% | 10% | 0% |
| AMOUNT | 14% | 14% | 0% |

**装箱单表格 (Packing List Table) 列宽调整：**
| 列名 | v2.1 | v2.2 | 变化 |
|------|------|------|------|
| # | 4% | 4% | 0% |
| DESCRIPTION | 32% | 26% | -6% |
| HS CODE | 10% | 10% | 0% |
| QTY. | 8% | 12% | +4% |
| UOM | 6% | 6% | 0% |
| DIMS (cm) | 12% | 12% | 0% |
| NET WT. | 9% | 10% | +1% |
| GROSS WT. | 9% | 10% | +1% |
| MEAS. (CBM) | 10% | 10% | 0% |

**效果：**
- ✅ QTY 列宽度增加 50%，可完整显示大数字
- ✅ NET WT 列宽度增加 25%，显示更清晰
- ✅ 表格字体缩小 7%，优化空间利用

---

### 2. 装箱单包装数量功能 (Package Quantity Feature)
**新功能：** 为装箱单的每个 Package 添加数量字段，支持"批量包装"模式。

**UI 改进：**
- ✅ 添加"件数 Quantity"输入框（默认值：1）
- ✅ 添加"总计 Total"显示框（绿色背景）
- ✅ 标签优化："毛重"改为"单箱毛重"，"体积"改为"单箱体积"
- ✅ 布局调整：第一行4个字段，第二行2个字段

**新的 Package 卡片布局：**
```
📦 包装 Package #1                                    [✖]
┌──────────────────────────────────────────────────────┐
│ [件数: 5] [类型: Carton▼] [尺寸: 120×80×100] [单箱毛重: 50.00]
│ [单箱体积: 0.960 CBM]  [总计: 毛重 250.00 KG | 体积 4.800 CBM]
│                                                      │
│ 包装内货物 Items in this Package:                    │
│ ... (items)                                          │
└──────────────────────────────────────────────────────┘
```

**实时计算功能：**
- ✅ 自动计算总毛重 = 单箱毛重 × 件数
- ✅ 自动计算总体积 = 单箱体积 × 件数
- ✅ 当件数、毛重或尺寸变化时，实时更新总计显示

**表格显示优化：**
```
# | DESCRIPTION | HS CODE | QTY. | UOM | DIMS | NET WT. | GROSS WT. | MEAS.
─────────────────────────────────────────────────────────────────────────────
  | Carton (5 packages)              | 120×80×100 |         | 250.00    | 4.800
```
- Package 标题行显示件数："Carton (5 packages)"
- GROSS WT 和 MEAS 列显示总值（自动乘以件数）

**业务价值：**
- ✅ 减少重复操作：5个相同箱子只需创建1个 Package
- ✅ 符合实际业务：出口常有多个相同规格的包装
- ✅ 数据准确性：自动计算避免手动错误

**数据持久化：**
- ✅ packages 字段正确保存到 localStorage
- ✅ 历史数据加载时正确恢复 packages 值
- ✅ 打印视图中正确显示计算后的总值

---

### 3. Bug 修复 - 锁定状态下无法切换单据类型
**问题：** 用户在发票模式下点击"步骤1：确认修订"后，表单被锁定，无法切换到装箱单模式。

**根本原因：**
- `setEditingLocked` 函数锁定时禁用所有表单元素
- 包括"单据类型"（document-mode）单选按钮
- 导致用户无法在发票和装箱单之间切换

**解决方案：**
- ✅ 在 `setEditingLocked` 函数中添加例外规则
- ✅ 允许 document-mode 单选按钮在锁定状态下仍可点击
- ✅ 切换时自动解锁表单并重置修订状态

**修复代码：**
```javascript
// Allow document-mode switching even when locked
if (el.name === 'document-mode') return;
```

**效果：**
- ✅ 即使表单锁定，仍可切换单据类型
- ✅ 切换时自动解锁，不影响工作流程
- ✅ 数据独立性得到保持

---

## 文件修改清单

### 核心文件
- ✅ `invoice_generator_v2.2.html` - 主应用文件（新版本）
- ✅ `manifest.json` - PWA 配置，更新所有 URL 引用
- ✅ `sw.js` - Service Worker，更新缓存版本

### 新增文件
- ✅ `CHANGELOG_v2.2.md` - 本变更日志

---

## 技术细节

### CSS 改动
```css
/* 表格字体缩小 */
.preview-table {
    font-size: 0.7rem; /* 从 0.75rem 减小 */
}
```

### HTML 结构改动
- 发票表格：8列宽度调整
- 装箱单表格：9列宽度调整
- Package 卡片：从 3 列布局改为 4 列布局

### JavaScript 改动
1. **addNewPackage()** - 添加 packages 字段和总计显示
2. **updateItemsAndTotals()** - 修改计算逻辑，乘以 packages 数量
3. **collectFormData()** - 添加 packages 字段保存
4. **setEditingLocked()** - 添加 document-mode 例外规则

---

## 测试建议

### 1. 表格显示测试
- [ ] 在发票中输入大数字（如 3,000,000），检查是否单行显示
- [ ] 在装箱单中输入大数字，检查 QTY 和 NET WT 列
- [ ] 打印预览，确认所有列宽合理

### 2. Package 数量功能测试
- [ ] 创建新 Package，检查"件数"字段是否显示
- [ ] 修改件数，验证"总计"实时更新
- [ ] 修改单箱毛重，验证总计更新
- [ ] 修改尺寸，验证单箱体积和总体积更新
- [ ] 保存并加载，验证 packages 值正确恢复
- [ ] 打印预览，检查表格中显示的总值是否正确

### 3. Bug 修复测试
- [ ] 在发票模式填写数据
- [ ] 点击"步骤1：确认修订"
- [ ] 尝试切换到"装箱单"模式，应该可以点击
- [ ] 切换后表单自动解锁
- [ ] 返回发票模式，已保存的修订仍存在

---

## 升级说明

### 从 v2.1 升级到 v2.2
1. 替换 `invoice_generator_v2.0.html` 为 `invoice_generator_v2.2.html`
2. 更新 `manifest.json` 和 `sw.js`
3. 清除浏览器缓存（Cmd+Shift+R 或 Ctrl+Shift+R）

### 数据兼容性
- ✅ 完全向后兼容 v2.1 和 v2.0 的数据
- ✅ 旧的 Package 数据会自动设置 packages = 1
- ✅ 不影响现有的已保存修订

---

## 已知问题
无

---

## 下一步计划
- 考虑添加批量导出功能
- 考虑添加模板保存功能
- 考虑添加多语言支持

---

## 贡献者
- Claude Code (AI Assistant)
- User: gazh

---

**完整版本历史：**
- v2.2.0 (2025-10-30) - 表格优化 + Package 数量功能 + Bug 修复
- v2.1.0 - 初始 Electron 版本
- v2.0 - PWA 版本
