<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸œå´ç”µå­å‘ç¥¨ç”Ÿæˆå¹³å°</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="QHD Invoice and Packing List Generator - Professional invoice generation tool">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QHD Invoice">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --a4-width-px: 794px; --a4-height-px: 1123px; }
        body { font-family: 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        /* Enhanced Form Section Styling */
        .form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 0.75rem;
            padding: 1.75rem;
            margin-bottom: 1.75rem;
            box-shadow: 0 2px 8px 0 rgb(0 0 0 / 0.08), 0 1px 3px -1px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .form-section:hover {
            box-shadow: 0 4px 12px 0 rgb(0 0 0 / 0.12), 0 2px 4px -1px rgb(0 0 0 / 0.1);
        }
        .form-section h2 {
            color: #111827;
            font-weight: 700;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e5e7eb;
            font-size: 1.125rem;
        }

        /* Enhanced Form Input Styling */
        .form-input, .form-select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
            background-color: #ffffff;
            font-size: 0.9375rem;
        }
        .form-input:hover, .form-select:hover {
            border-color: #9ca3af;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: #fffbeb;
        }

        /* Enhanced Label Styling */
        label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            display: block;
            margin-bottom: 0.375rem;
        }
        label.block {
            font-weight: 700;
            color: #1f2937;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            letter-spacing: -0.01em;
        }
        label.block.text-sm {
            font-size: 0.9375rem;
        }

        /* Field group spacing */
        .form-section > div > div {
            margin-bottom: 1.25rem;
        }
        .form-section > div > div:last-child {
            margin-bottom: 0;
        }
        
        .main-layout { display: flex; gap: 2rem; align-items: flex-start; }
        .form-column {
            flex: 1;
            min-width: 600px;
            max-width: calc(100vw - 720px);
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 2rem;
        }
        .preview-column {
            width: 640px !important;
            flex-shrink: 0;
            min-width: 640px;
            position: sticky;
            top: 20px;
        }
        
        /* --- Preview Scaling Styles --- */
        .preview-wrapper {
            width: 560px;
            margin: 0 auto;
            padding: 0;
            background: transparent;
        }
        #invoice-preview {
            width: var(--a4-width-px);
            min-height: var(--a4-height-px);
            padding: 68px; /* ~1.8cm */
            font-size: 10px;
            transform-origin: top left;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* --- Preview Content Styles --- */
        #invoice-preview > h1 { margin-bottom: 2.5rem; } /* Increased spacing */
        #invoice-preview > .grid:nth-of-type(1) { margin-bottom: 2rem; } /* Increased spacing */
        #invoice-preview > .grid:nth-of-type(2) { margin-bottom: 2rem; } /* Increased spacing */

        .preview-table { border-collapse: collapse; table-layout: fixed; width: 100%; font-size: 0.7rem; }
        .preview-table th, .preview-table td { padding: 6px 4px; vertical-align: top; border-bottom: 1px solid #e5e7eb; word-break: break-word; }
        .preview-table th { font-weight: 600; text-align: left; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom-width: 2px; padding-bottom: 8px; }
        .preview-table .text-center { text-align: center; } .preview-table .text-right { text-align: right; }
        .preview-table tfoot td { font-weight: 600; border-top: 2px solid #374151; border-bottom: none; }
        .preview-table td.hs-code-cell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.7rem; padding-left: 2px; padding-right: 2px; }
        .preview-identity-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 0.75rem; font-size: 0.76rem; color: #1f2937; border: 1px solid #d1d5db; border-radius: 0.45rem; overflow: hidden; }
        .preview-identity-table th { text-align: left; font-weight: 600; padding: 6px 10px; background: #f3f4f6; width: 32%; border-bottom: 1px solid #e5e7eb; }
        .preview-identity-table td { padding: 6px 10px; border-bottom: 1px solid #e5e7eb; }
        .preview-identity-table tr:last-child th,
        .preview-identity-table tr:last-child td { border-bottom: none; }
        #revision-history { margin-top: 0.75rem; }
        #revision-history table { width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        #revision-history th, #revision-history td { padding: 3px 6px; font-size: 0.72rem; border-bottom: 1px solid #e5e7eb; }
        #revision-history th { background: #f9fafb; color: #4b5563; text-align: left; font-weight: 600; }
        #revision-history tr.revision-row { cursor: pointer; }
        #revision-history tr.revision-row:hover { background: #e0f2fe; }
        #revision-history tr.revision-row.is-selected { background: #bfdbfe; color: #1d4ed8; }
        #revision-history tr.revision-row.is-latest:not(.is-selected) { background: #f3f4f6; font-weight: 600; }
        #revision-history button[data-revision-delete] { font-size: 0.7rem; padding: 2px 6px; border-radius: 0.25rem; border: 1px solid #ef4444; color: #ef4444; background: #fff; }
        #revision-history button[data-revision-delete]:hover { background: #fee2e2; }
        #start-new-revision-btn {
            margin-top: 0.5rem;
            font-size: 0.72rem;
            border-radius: 0.375rem;
            padding: 4px 10px;
            font-weight: 600;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            background: #eff6ff;
        }
        #start-new-revision-btn:hover:not(:disabled) { background: #dbeafe; }
        #start-new-revision-btn:disabled, #confirm-revision-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .revision-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 1px solid #6ee7b7;
            background: #ecfdf5;
            color: #047857;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .revision-indicator .indicator-label {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            text-transform: uppercase;
            font-size: 0.68rem;
            letter-spacing: 0.12em;
        }
        .revision-indicator .indicator-value {
            padding: 2px 8px;
            border-radius: 0.5rem;
            background: rgba(255,255,255,0.7);
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            font-size: 0.85rem;
            letter-spacing: 0.08em;
        }
        .revision-indicator .indicator-extra {
            font-size: 0.68rem;
            opacity: 0.85;
        }
        .revision-indicator .indicator-extra strong {
            font-weight: 700;
            margin-left: 0.2rem;
        }
        .revision-indicator.is-locked {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1d4ed8;
        }
        .revision-indicator.is-stale {
            box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.25);
        }

        .party-info-block { margin-bottom: 1rem; }
        .party-info-block h3 { font-size: 0.65rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem; letter-spacing: 0.05em; text-transform: uppercase; border-bottom: 1px solid #e5e7eb; padding-bottom: 3px; }
        .custom-combo { display: flex; gap: 0.5rem; }

        /* Document Type Visual Distinction */
        body.doc-mode-invoice #invoice-preview { border-left: 4px solid #2563eb; }
        body.doc-mode-invoice .preview-identity-table { background: #eff6ff; }
        body.doc-mode-invoice .preview-identity-table th { background: #dbeafe; color: #1e40af; }
        body.doc-mode-invoice [data-target="invoice-title"] {
            color: #1e40af !important;
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #93c5fd;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }
        body.doc-mode-invoice .preview-table thead { background: #eff6ff; }
        body.doc-mode-invoice .preview-table th { color: #1e40af; }

        body.doc-mode-commercial #invoice-preview { border-left: 4px solid #059669; }
        body.doc-mode-commercial .preview-identity-table { background: #f0fdf4; }
        body.doc-mode-commercial .preview-identity-table th { background: #bbf7d0; color: #065f46; }
        body.doc-mode-commercial [data-target="invoice-title"] {
            color: #065f46 !important;
            background: linear-gradient(135deg, #bbf7d0 0%, #f0fdf4 100%);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #86efac;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.15);
        }
        body.doc-mode-commercial .preview-table thead { background: #f0fdf4; }
        body.doc-mode-commercial .preview-table th { color: #065f46; }

        body.doc-mode-proforma #invoice-preview { border-left: 4px solid #f97316; }
        body.doc-mode-proforma .preview-identity-table { background: #fff7ed; }
        body.doc-mode-proforma .preview-identity-table th { background: #fed7aa; color: #c2410c; }
        body.doc-mode-proforma [data-target="invoice-title"] {
            color: #c2410c !important;
            background: linear-gradient(135deg, #fed7aa 0%, #fff7ed 100%);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #fb923c;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);
        }
        body.doc-mode-proforma .preview-table thead { background: #fff7ed; }
        body.doc-mode-proforma .preview-table th { color: #c2410c; }

        body.doc-mode-packing #invoice-preview { border-left: 4px solid #14b8a6; }
        body.doc-mode-packing .preview-identity-table { background: #f0fdfa; }
        body.doc-mode-packing .preview-identity-table th { background: #99f6e4; color: #0f766e; }
        body.doc-mode-packing [data-target="invoice-title"] {
            color: #0f766e !important;
            background: linear-gradient(135deg, #99f6e4 0%, #f0fdfa 100%);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid #5eead4;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.15);
        }
        body.doc-mode-packing .preview-table thead { background: #f0fdfa; }
        body.doc-mode-packing .preview-table th { color: #0f766e; }

        /* Form Section Visual Distinction */
        body.doc-mode-invoice .form-section {
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08), 0 1px 3px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #eff6ff 0%, #ffffff 2%);
        }
        body.doc-mode-invoice .form-section h2 {
            color: #1e40af;
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            padding: 0.75rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 2px solid #93c5fd;
        }
        body.doc-mode-commercial .form-section {
            border-left: 4px solid #059669;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.08), 0 1px 3px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #f0fdf4 0%, #ffffff 2%);
        }
        body.doc-mode-commercial .form-section h2 {
            color: #065f46;
            background: linear-gradient(135deg, #bbf7d0 0%, #f0fdf4 100%);
            padding: 0.75rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 2px solid #86efac;
        }
        body.doc-mode-proforma .form-section {
            border-left: 4px solid #f97316;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.08), 0 1px 3px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #fff7ed 0%, #ffffff 2%);
        }
        body.doc-mode-proforma .form-section h2 {
            color: #c2410c;
            background: linear-gradient(135deg, #fed7aa 0%, #fff7ed 100%);
            padding: 0.75rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 2px solid #fb923c;
        }
        body.doc-mode-packing .form-section {
            border-left: 4px solid #14b8a6;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.08), 0 1px 3px -1px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #f0fdfa 0%, #ffffff 2%);
        }
        body.doc-mode-packing .form-section h2 {
            color: #0f766e;
            background: linear-gradient(135deg, #99f6e4 0%, #f0fdfa 100%);
            padding: 0.75rem 1rem;
            margin: -1rem -1rem 1rem -1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border-bottom: 2px solid #5eead4;
        }
        body.doc-mode-invoice .item-row {
            border-left: 3px solid #93c5fd !important;
        }
        body.doc-mode-commercial .item-row {
            border-left: 3px solid #86efac !important;
        }
        body.doc-mode-proforma .item-row {
            border-left: 3px solid #fb923c !important;
        }
        body.doc-mode-packing .item-row {
            border-left: 3px solid #5eead4 !important;
        }

        /* Radio button enhancement */
        input[type="radio"] {
            width: 1.125rem;
            height: 1.125rem;
            cursor: pointer;
        }

        /* Radio button labels */
        label.flex.items-center {
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            background: #f9fafb;
            margin-right: 0.5rem;
        }
        label.flex.items-center:hover {
            background: #f3f4f6;
            border-color: #e5e7eb;
            transform: translateY(-1px);
        }
        label.flex.items-center:has(input:checked) {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #93c5fd;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
            transform: translateY(0);
        }
        body.doc-mode-commercial label.flex.items-center:has(input[name="invoice-type"][value="COMMERCIAL INVOICE"]:checked) {
            background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%);
            border-color: #86efac;
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.15);
        }
        body.doc-mode-proforma label.flex.items-center:has(input[name="invoice-type"][value="PROFORMA INVOICE"]:checked) {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-color: #fb923c;
            box-shadow: 0 2px 6px rgba(249, 115, 22, 0.15);
        }
        body.doc-mode-packing label.flex.items-center:has(input[name="document-mode"]:checked) {
            background: linear-gradient(135deg, #f0fdfa 0%, #99f6e4 100%);
            border-color: #5eead4;
            box-shadow: 0 2px 6px rgba(20, 184, 166, 0.15);
        }

        /* Radio button group containers */
        .flex.space-x-4 {
            gap: 0.5rem;
        }

        input[name="document-mode"]:checked + span,
        input[name="invoice-type"]:checked + span {
            font-weight: 700;
            color: #1f2937;
        }
        input[name="document-mode"][value="invoice"]:checked + span {
            color: #1e40af;
        }
        input[name="document-mode"][value="packing"]:checked + span {
            color: #0f766e;
        }
        input[name="invoice-type"][value="INVOICE"]:checked + span {
            color: #1e40af;
        }
        input[name="invoice-type"][value="COMMERCIAL INVOICE"]:checked + span {
            color: #065f46;
        }
        input[name="invoice-type"][value="PROFORMA INVOICE"]:checked + span {
            color: #c2410c;
        }

        /* Setup section specific styling */
        .form-section:first-child {
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
            border: 2px solid #dbeafe;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
        }
        body.doc-mode-commercial .form-section:first-child {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
            border: 2px solid #bbf7d0;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.12);
        }
        body.doc-mode-proforma .form-section:first-child {
            background: linear-gradient(135deg, #ffffff 0%, #fff7ed 100%);
            border: 2px solid #fed7aa;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.12);
        }
        body.doc-mode-packing .form-section:first-child {
            background: linear-gradient(135deg, #ffffff 0%, #f0fdfa 100%);
            border: 2px solid #99f6e4;
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.12);
        }
        .form-section:first-child h2::before {
            content: "âš™ï¸ ";
            margin-right: 0.5rem;
        }

        /* Enhanced Item Card Styling */
        .item-row {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%) !important;
            border: 2px solid #e5e7eb !important;
            border-radius: 0.75rem !important;
            padding: 1.25rem !important;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
            position: relative;
        }
        .item-row:hover {
            border-color: #d1d5db !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .item-row > p:first-of-type {
            color: #1f2937;
            font-weight: 700;
            font-size: 0.9375rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        .item-row > p:first-of-type::before {
            content: "ğŸ“¦";
            margin-right: 0.5rem;
            font-size: 1.125rem;
        }
        .remove-item-btn {
            background: #fee2e2;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.15s ease;
        }
        .remove-item-btn:hover {
            background: #fecaca;
            transform: scale(1.1);
        }

        /* Package Cards for Packing List */
        body.doc-mode-packing .package-card {
            border-left: 4px solid #14b8a6 !important;
            background: linear-gradient(135deg, #f0fdfa 0%, #ffffff 100%) !important;
            box-shadow: 0 2px 8px rgba(20, 184, 166, 0.12) !important;
        }
        body.doc-mode-packing .package-card p:first-child {
            color: #0f766e !important;
            font-weight: 700;
        }
        body.doc-mode-packing .package-item {
            border-left: 3px solid #5eead4 !important;
            background: #ffffff !important;
        }

        /* Textarea specific styling */
        textarea.form-input {
            resize: vertical;
            min-height: 3.5rem;
            font-family: inherit;
        }

        /* Helper text and hints */
        .text-xs {
            color: #6b7280;
            line-height: 1.5;
        }

        /* Button styling improvements */
        button {
            font-weight: 600;
            transition: all 0.15s ease;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }

        /* Grid layout improvements */
        .grid {
            gap: 1rem;
        }

        /* Custom combo box clarity */
        .custom-combo .form-select,
        .custom-combo .form-input {
            flex: 1;
        }

        .modal { background-color: rgba(0,0,0,0.5); z-index: 100; }
        .modal-content { z-index: 110; position: relative; }
        .toast { position: fixed; top: 20px; right: 20px; background-color: #28a745; color: white; padding: 12px 20px; border-radius: 5px; z-index: 1000; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease-out; font-size: 14px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Download preparation animation */
        .download-prep {
            position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1001; opacity: 0; transform: translateY(-20px) scale(0.9);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 14px; font-weight: 500;
            display: flex; align-items: center; gap: 12px;
        }
        .download-prep.show { opacity: 1; transform: translateY(0) scale(1); }
        .download-icon { width: 20px; height: 20px; animation: bounce 1.5s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .prep-text { display: flex; flex-direction: column; line-height: 1.2; }
        .prep-title { font-weight: 600; margin-bottom: 2px; }
        .prep-subtitle { font-size: 12px; opacity: 0.9; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="toast-notification" class="toast"></div>
    <div id="download-prep" class="download-prep">
        <svg class="download-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        </svg>
        <div class="prep-text">
            <div class="prep-title">å‡†å¤‡æ‰“å°è§†å›¾...</div>
            <div class="prep-subtitle">æµè§ˆå™¨å³å°†æ‰“å¼€å¯æ‰“å°ç‰ˆæœ¬</div>
        </div>
    </div>
    <div id="shipper-profile-manager" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">ç®¡ç†å‘è´§æ–¹ä¿¡æ¯</h2>
            <div id="shipper-profile-list" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
            <h3 class="text-lg font-semibold mb-2" id="profile-editor-title">æ·»åŠ æ–°å‘è´§æ–¹</h3>
            <div class="space-y-3">
                <input type="hidden" id="profile-id">
                <div><label>åç§° (ç”¨äºä¸‹æ‹‰èœå•)</label><input type="text" id="profile-name" class="form-input mt-1"></div>
                <div><label>åœ°å€ (Shipper Address)</label><textarea id="profile-address" rows="4" class="form-input mt-1"></textarea></div>
                <div><label>é“¶è¡Œä¿¡æ¯ (Bank Details)</label><textarea id="profile-bank" rows="4" class="form-input mt-1"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-profile-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">å–æ¶ˆ</button>
                <button id="save-profile" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="consignee-profile-manager" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">ç®¡ç†æ”¶è´§äººä¿¡æ¯</h2>
            <div id="consignee-profile-list" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
            <h3 class="text-lg font-semibold mb-2" id="consignee-editor-title">æ·»åŠ æ–°æ”¶è´§äºº</h3>
            <div class="space-y-3">
                <input type="hidden" id="consignee-profile-id">
                <div><label>åç§° (ç”¨äºä¸‹æ‹‰èœå•)</label><input type="text" id="consignee-profile-name" class="form-input mt-1"></div>
                <div><label>åœ°å€ (Consignee Address)</label><textarea id="consignee-profile-address" rows="4" class="form-input mt-1"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-consignee-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">å–æ¶ˆ</button>
                <button id="save-consignee" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="billto-profile-manager" class="modal fixed inset-0 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">ç®¡ç†ä»˜æ¬¾æ–¹ä¿¡æ¯</h2>
            <div id="billto-profile-list" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
            <h3 class="text-lg font-semibold mb-2" id="billto-editor-title">æ·»åŠ æ–°ä»˜æ¬¾æ–¹</h3>
            <div class="space-y-3">
                <input type="hidden" id="billto-profile-id">
                <div><label>åç§° (ç”¨äºä¸‹æ‹‰èœå•)</label><input type="text" id="billto-profile-name" class="form-input mt-1"></div>
                <div><label>åœ°å€ (Bill To Address)</label><textarea id="billto-profile-address" rows="4" class="form-input mt-1"></textarea></div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-billto-edit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded">å–æ¶ˆ</button>
                <button id="save-billto" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">ä¸œå´ç”µå­å‘ç¥¨ç”Ÿæˆå¹³å°</h1>
            <p class="text-gray-500 mt-2 text-sm">Developed by Xuan Zhang (xuan.zhang@qhdpv.com)</p>
        </header>
        <main class="main-layout">
            <div class="form-column">
                <div id="form-container">
                    <!-- Form sections -->
                    <div class="form-section"><h2 class="text-xl font-semibold mb-4 border-b pb-2">åŸºç¡€è®¾ç½® Setup</h2>
                        <div><label class="block text-sm font-medium text-gray-700">å•æ®ç±»å‹ Document Mode</label><div class="mt-2 flex space-x-4">
                            <label class="flex items-center"><input type="radio" name="document-mode" value="invoice" class="form-radio" checked> <span class="ml-2">å‘ç¥¨ Invoice</span></label>
                            <label class="flex items-center"><input type="radio" name="document-mode" value="packing" class="form-radio"> <span class="ml-2">è£…ç®±å• Packing List (PL)</span></label>
                        </div></div>
                        <div data-doc="invoice"><label class="block text-sm font-medium text-gray-700">å‘ç¥¨ç±»å‹ Invoice Type</label><div class="mt-2 flex space-x-4">
                            <label class="flex items-center"><input type="radio" name="invoice-type" value="INVOICE" class="form-radio" checked> <span class="ml-2">æ™®é€šå‘ç¥¨ Standard Invoice</span></label>
                            <label class="flex items-center"><input type="radio" name="invoice-type" value="COMMERCIAL INVOICE" class="form-radio"> <span class="ml-2">å•†ä¸šå‘ç¥¨ Commercial Invoice (CI)</span></label>
                            <label class="flex items-center"><input type="radio" name="invoice-type" value="PROFORMA INVOICE" class="form-radio"> <span class="ml-2">å½¢å¼å‘ç¥¨ Proforma Invoice (PI)</span></label>
                        </div></div>
                    </div>
                    <div class="form-section"><h2 id="document-details-heading" class="text-xl font-semibold mb-4 border-b pb-2">å‘ç¥¨ä¿¡æ¯ Invoice Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-gray-700">å‘ç¥¨æ—¥æœŸ Invoice Date</label><input type="date" id="date" class="form-input mt-1"></div>
                            <div data-doc="invoice"><label class="block text-sm font-medium text-gray-700">ä»˜æ¬¾æ¡ä»¶ Payment Terms</label><div class="custom-combo mt-1"><select id="payment-terms-select" class="form-select"></select><input type="text" id="payment-terms-custom" class="form-input hidden"></div></div>
                            <div class="col-span-2">
                                <label id="document-number-label" class="block text-sm font-medium text-gray-700">å‘ç¥¨å·ç  Invoice No.</label>
                                <div class="flex flex-wrap items-center gap-3 mt-2 font-mono text-sm">
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-700" id="document-prefix-label">QHD-INV-</span>
                                        <input type="text" id="invoice-date-segment" class="form-input w-28" title="æ—¥æœŸæ®µ Date Segment (YYYYMMDD)">
                                        <span class="text-gray-500">-</span>
                                        <input type="text" id="invoice-seq" class="form-input w-14" title="åºå· Sequence">
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-gray-700">Revision</span>
                                        <input type="text" id="invoice-version" value="A" class="form-input w-12" title="ä¿®è®¢å· Revision">
                                    </div>
                                <span class="text-xs text-gray-500" id="invoice-base-display"></span>
                                </div>
                                <p id="invoice-version-indicator" class="revision-indicator mt-2" aria-live="polite"></p>
                                <div class="flex items-center gap-2 mt-1">
                                    <button type="button" id="start-new-revision-btn" class="hidden">æ–°å»ºä¿®è®¢ Start New Revision</button>
                                </div>
                                <p id="editing-lock-banner" class="text-xs text-red-600 mt-1 hidden">Viewing historical revision. Editing is disabled. è¿”å›æœ€æ–°ä¿®è®¢ä»¥ç»§ç»­ç¼–è¾‘ / Switch to the latest revision to edit.</p>
                                <div id="revision-history" class="mt-3">
                                    <p class="text-xs text-gray-600 font-semibold mb-1">ä¿®è®¢å†å² Revision History</p>
                                    <table>
                                        <thead><tr><th class="w-1/4">ä¿®è®¢<br>Revision</th><th class="w-1/2">ä¿å­˜æ—¶é—´<br>Saved</th><th class="w-1/4 text-right">æ“ä½œ<br>Actions</th></tr></thead>
                                        <tbody id="revision-table-body"><tr><td colspan="3" class="text-center text-gray-400 py-2">No revisions yet</td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700">è®¢å•å· Order No.</label><input type="text" id="order-no" class="form-input mt-1"></div>
                            <div data-doc="invoice" data-template="ci-only"><label class="block text-sm font-medium text-gray-700">è´¸æ˜“æœ¯è¯­ Incoterms</label><div class="custom-combo mt-1"><select id="incoterms-select" class="form-select"></select><input type="text" id="incoterms-custom" class="form-input hidden"></div></div>
                            <div class="md:col-span-1" data-doc="packing">
                                <label class="block text-sm font-medium text-gray-700">å‚è€ƒå‘ç¥¨å· Reference Invoice</label>
                                <input type="text" id="packing-invoice-ref" list="saved-invoices-list" class="form-input mt-1" placeholder="ä¾‹å¦‚ QHD-INV-20240101-01">
                                <datalist id="saved-invoices-list"></datalist>
                            </div>
                            <div class="md:col-span-1" data-doc="packing"><label class="block text-sm font-medium text-gray-700">å¤‡æ³¨ Notes</label><textarea id="packing-notes" rows="3" class="form-input mt-1" placeholder="å¡«å†™æœ¬æ¬¡è£…ç®±è¯´æ˜ã€åŒ…è£…è¦æ±‚ç­‰"></textarea></div>
                        </div>
                    </div>
                    <div class="form-section"><h2 class="text-xl font-semibold mb-4 border-b pb-2">å‘è´§æ–¹ä¸é“¶è¡Œä¿¡æ¯ Shipper & Bank Info</h2>
                        <label class="block text-sm font-medium text-gray-700">é€‰æ‹©å‘è´§æ–¹ Select Shipper</label>
                        <div class="flex items-center gap-2 mt-1">
                            <select id="shipper-select" class="form-select flex-grow"></select>
                            <button id="manage-shippers-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-2 px-3 rounded flex-shrink-0">ç®¡ç† Manage</button>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mt-4" for="payment-details" data-doc="invoice">æ”¶æ¬¾è´¦å·ä¸é“¶è¡Œä¿¡æ¯ Payment Details</label>
                        <textarea id="payment-details" rows="4" class="form-input mt-2" placeholder="å¡«å†™æœ¬æ¬¡å‘ç¥¨ä½¿ç”¨çš„æ”¶æ¬¾è¯¦ç»†ä¿¡æ¯ / Enter bank details for this invoice" data-doc="invoice"></textarea>
                        <p class="text-xs text-gray-500 mt-2" data-doc="invoice">æç¤º Tipï¼šé€‰æ‹©ä¸åŒå‘è´§æ–¹æ—¶å°†è‡ªåŠ¨å¡«å……å¯¹åº”é“¶è¡Œä¿¡æ¯ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨æ­¤è¿›è¡Œè¦†ç›–ã€‚</p>
                    </div>
                    <div class="form-section"><h2 class="text-xl font-semibold mb-4 border-b pb-2">æ”¶è´§æ–¹ & å…¶ä»–ç›¸å…³æ–¹ Consignee & Parties</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">æ”¶è´§äºº Consignee</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <select id="consignee-select" class="form-select flex-grow"></select>
                                    <button id="manage-consignees-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-2 px-3 rounded flex-shrink-0">ç®¡ç† Manage</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ä»˜æ¬¾æ–¹ Bill To</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <select id="billto-select" class="form-select flex-grow"></select>
                                    <button id="manage-billto-btn" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-2 px-3 rounded flex-shrink-0">ç®¡ç† Manage</button>
                                </div>
                            </div>
                            <div data-doc="invoice" data-template="ci-only">
                                <label class="block text-sm font-medium text-gray-700">é€šçŸ¥æ–¹ Notify Party</label>
                                <textarea id="notify-party" rows="2" class="form-input mt-1" placeholder="å¦‚æœä¸Consigneeç›¸åŒåˆ™æ— éœ€å¡«å†™"></textarea>
                                <p class="text-xs text-gray-500 mt-1">æç¤º Tipï¼šç•™ç©ºåˆ™é»˜è®¤æ˜¾ç¤º "SAME AS CONSIGNEE"</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-section"><h2 class="text-xl font-semibold mb-4 border-b pb-2">è´§ç‰©æ˜ç»† Line Items</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div data-doc="invoice" data-template="ci-only"><label class="block text-sm font-medium text-gray-700">åŸäº§å›½ Country of Origin</label><div class="custom-combo mt-1"><select id="country-of-origin-select" class="form-select"></select><input type="text" id="country-of-origin-custom" class="form-input hidden"></div></div>
                            <div><label class="block text-sm font-medium text-gray-700">è´§å¸ Currency</label><div class="custom-combo mt-1"><select id="currency-select" class="form-select"></select><input type="text" id="currency-custom" class="form-input hidden"></div></div>
                        </div>
                        <div id="items-container" class="space-y-4 mt-4"></div>
                        <button id="add-item-btn" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-colors duration-300">+ æ·»åŠ æ–°æ¡ç›® Add Item</button>
                    </div>
                    <div class="mt-8 flex flex-col items-end space-y-4">
                        <button id="confirm-revision-btn" class="hidden bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg text-lg shadow-lg transition-transform transform hover:scale-105 duration-300 flex items-center justify-center w-full sm:w-auto sm:max-w-xs">
                            âœ… æ­¥éª¤1ï¼šç¡®è®¤ä¿®è®¢ Step 1: Confirm Revision
                        </button>
                        <button id="open-printable-html-btn" class="border border-green-600 text-green-700 font-bold py-3 px-8 rounded-lg text-lg shadow-sm bg-white hover:bg-green-50 transition-transform transform hover:scale-105 duration-300 flex items-center justify-center w-full sm:w-auto sm:max-w-xs">
                            <span id="html-btn-text">ğŸ–¨ï¸ æ­¥éª¤2ï¼šæ‰“å¼€æ‰“å°è§†å›¾ Step 2: Open Print View</span>
                            <span id="html-btn-loader" class="hidden"><span class="spinner"></span>å‡†å¤‡æ‰“å°...</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="preview-column">
                    <div class="preview-wrapper">
                        <div id="invoice-preview">
                            <h1 class="text-center text-xl font-bold tracking-wider" data-target="invoice-title">COMMERCIAL INVOICE</h1>
                            <table class="preview-identity-table">
                                <tbody>
                                    <tr>
                                    <th data-target="identity-label-primary">Invoice No.</th>
                                    <td data-target="preview-invoice-base"></td>
                                    </tr>
                                    <tr>
                                    <th>Revision</th>
                                    <td data-target="preview-invoice-revision"></td>
                                    </tr>
                                    <tr data-doc="packing">
                                    <th>Reference Invoice</th>
                                    <td data-target="packing-invoice-reference"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="grid grid-cols-2 gap-x-6 text-xs">
                                <div>
                                    <p><strong>Date:</strong> <span data-target="date"></span></p>
                                    <p><strong>Order No.:</strong> <span data-target="order-no"></span></p>
                                </div>
                                <div class="text-right">
                                    <p data-doc="invoice"><strong>Payment Due Date:</strong> <span data-target="payment-due-date"></span></p>
                                    <p data-doc="invoice"><strong>Payment Terms:</strong> <span data-target="payment-terms"></span></p>
                                    <p data-doc="invoice" data-template="ci-only"><strong>Incoterms:</strong> <span data-target="incoterms"></span></p>
                                    <p data-doc="packing"><strong>Total Packages:</strong> <span data-target="pl-total-packages"></span></p>
                                    <p data-doc="packing"><strong>Total Gross Weight (KG):</strong> <span data-target="pl-total-gross"></span></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-x-6 text-xs">
                                <div class="party-info-block"><h3>Shipper/Exporter</h3><pre class="whitespace-pre-wrap break-words text-xs" data-target="shipper"></pre></div>
                                <div class="party-info-block"><h3>Consignee</h3><pre class="whitespace-pre-wrap break-words text-xs" data-target="consignee"></pre></div>
                                <div class="party-info-block"><h3>Bill To</h3><pre class="whitespace-pre-wrap break-words text-xs" data-target="bill-to"></pre></div>
                                <div class="party-info-block" data-doc="invoice" data-template="ci-only"><h3>Notify Party</h3><pre class="whitespace-pre-wrap break-words text-xs" data-target="notify-party"></pre></div>
                                <div class="party-info-block" data-doc="invoice" data-template="ci-only"><h3>Country of Origin</h3><p class="text-xs" data-target="country-of-origin"></p></div>
                                <div class="party-info-block"><h3>Currency of Sale</h3><p class="text-xs" data-target="currency"></p></div>
                            </div>
                            <table class="w-full preview-table text-xs mt-2" data-doc="invoice">
                                <thead><tr>
                                    <th class="w-[4%]">#</th>
                                    <th class="w-[32%]">DESCRIPTION</th>
                                    <th class="w-[11%]" data-template="ci-only">HS CODE</th>
                                    <th class="w-[10%] text-right" data-template="ci-only">NET WT.</th>
                                    <th class="w-[12%] text-center">QTY.</th>
                                    <th class="w-[7%]">UOM</th>
                                    <th class="w-[10%] text-right">UNIT PRICE</th>
                                    <th class="w-[14%] text-right">AMOUNT</th>
                                </tr></thead>
                                <tbody id="preview-items-body"></tbody>
                                <tfoot id="preview-total-footer"><tr><td id="total-colspan" colspan="7" class="text-right pr-4 font-bold">TOTAL</td><td class="text-right font-bold" data-target="total-amount">$0.00</td></tr></tfoot>
                            </table>
                            <table class="w-full preview-table text-xs mt-2" data-doc="packing">
                                <thead><tr>
                                    <th class="w-[4%]">#</th>
                                    <th class="w-[26%]">DESCRIPTION</th>
                                    <th class="w-[10%]">HS CODE</th>
                                    <th class="w-[12%] text-center">QTY.</th>
                                    <th class="w-[6%]">UOM</th>
                                    <th class="w-[12%] text-center">DIMS (cm)<br>LÃ—WÃ—H</th>
                                    <th class="w-[10%] text-right">NET WT.<br>(KG)</th>
                                    <th class="w-[10%] text-right">GROSS WT.<br>(KG)</th>
                                    <th class="w-[10%] text-right">MEAS.<br>(CBM)</th>
                                </tr></thead>
                                <tbody id="preview-packing-items-body"></tbody>
                                <tfoot><tr>
                                    <td colspan="6" class="text-right pr-4 font-bold">TOTALS</td>
                                    <td class="text-right font-bold" data-target="pl-total-net">0.00</td>
                                    <td class="text-right font-bold" data-target="pl-total-gross">0.00</td>
                                    <td class="text-right font-bold" data-target="pl-total-volume">0.000</td>
                                </tr></tfoot>
                            </table>
                            <div class="mt-4 text-xs" data-doc="invoice"><strong>PAYMENT DETAILS:</strong><pre class="whitespace-pre-wrap break-words text-xs mt-1" data-target="bank-details"></pre></div>
                            <div class="mt-4 text-xs" data-doc="packing"><strong>ADDITIONAL NOTES:</strong><pre class="whitespace-pre-wrap break-words text-xs mt-1" data-target="packing-notes"></pre></div>
                        </div>
                    </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const D = id => document.getElementById(id);
    const Q = sel => document.querySelector(sel);
    const QA = sel => document.querySelectorAll(sel);
    let shipperProfiles = {};
    let consigneeProfiles = {};
    let billToProfiles = {};
    let packageCounter = 0;
    let invoiceDateSegmentDirty = false;
    let lastAutoInvoiceSegment = '';
    let paymentDetailsDirty = false;
    let lastAutoPaymentDetails = '';
    let invoiceSeqDirty = false;
    let lastAutoDocumentSeq = '';
    let invoiceVersionDirty = false;
    let lastAutoInvoiceVersion = 'A';
    let latestStoredRevision = '';
    let currentRevisionLoaded = '';
    let lastRenderedRevisionBase = '';
    let editingLocked = false;
    let revisionConfirmed = false;
    const getDocumentMode = () => (Q('input[name="document-mode"]:checked')?.value || 'invoice');
    const isPackingMode = () => getDocumentMode() === 'packing';
    const getInvoiceType = () => (Q('input[name="invoice-type"]:checked')?.value || 'INVOICE');
    const isProformaInvoice = () => getInvoiceType() === 'PROFORMA INVOICE';
    const isCommercialInvoice = () => getInvoiceType() === 'COMMERCIAL INVOICE';
    const getDocumentPrefix = () => {
        if (isPackingMode()) return 'QHD-PL';
        return 'QHD-INV';
    };
    const getSequenceKeyPrefix = () => {
        if (isPackingMode()) return 'packingSeq_';
        return 'invoiceSeq_';
    };
    const newRevisionBtn = D('start-new-revision-btn');
    const confirmRevisionBtn = D('confirm-revision-btn');
    const defaultShipperProfiles = {
        'sample-company': { name: 'ç¤ºä¾‹è´¸æ˜“æœ‰é™å…¬å¸', address: 'ç¤ºä¾‹è´¸æ˜“æœ‰é™å…¬å¸\nåœ°å€ï¼šä¸­å›½ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº\nä¸–çºªå¤§é“1568å·\né‚®ç¼–ï¼š200122', bankDetails: 'é“¶è¡Œï¼šä¸­å›½é“¶è¡Œä¸Šæµ·åˆ†è¡Œ\nSWIFT: BKCHCNSH\nè´¦å·: 123456789012345' },
        'demo-trading': { name: 'Demo International Trading Co.', address: 'Demo International Trading Co.\nBuilding A, International Trade Center\n888 Business Avenue\nShenzhen, Guangdong 518000, China', bankDetails: 'Bank: Industrial and Commercial Bank of China\nSWIFT: ICBKCNBJ\nA/C No.: 987654321098765' },
    };
    const optionConfigs = {
        paymentTerms: { options: ['Net 120', 'Net 90', 'Net 60', 'Net 30', '100% T/T in Advance'], default: 'Net 120' },
        incoterms: { options: ['EXW', 'FOB', 'CIF', 'DAP'], default: 'EXW' },
        countryOfOrigin: { options: ['China', 'Vietnam'], default: 'China' },
        currency: { options: ['USD', 'RMB'], default: 'USD' },
        uom: { options: ['EA', 'MTR', 'PCS', 'KG', 'SET'], default: 'EA' },
        packageType: { options: ['Carton', 'Crate', 'Pallet', 'Foam', 'Bundle', 'Box', 'Case'], default: 'Carton' }
    };

    const generateInvoiceDateSegment = (dateVal) => {
        if (!dateVal) return '';
        return dateVal.replace(/-/g, '');
    };

    const getDefaultPaymentDetails = (shipperId) => {
        return shipperProfiles[shipperId]?.bankDetails || '';
    };

    function syncInvoiceDateSegment(options = { force: false }) {
        const segmentInput = D('invoice-date-segment');
        if (!segmentInput) return false;
        const dateVal = D('date').value;
        const defaultSegment = generateInvoiceDateSegment(dateVal);
        if (!defaultSegment) return false;
        const shouldUpdate = options.force || !invoiceDateSegmentDirty || segmentInput.value === lastAutoInvoiceSegment;
        lastAutoInvoiceSegment = defaultSegment;
        if (shouldUpdate) {
            if (segmentInput.value !== defaultSegment) {
                segmentInput.value = defaultSegment;
            }
            invoiceDateSegmentDirty = false;
            latestStoredRevision = '';
            updateRevisionIndicator(latestStoredRevision);
            return true;
        }
        return false;
    }

    function syncPaymentDetailsWithShipper(options = { force: false }) {
        const paymentField = D('payment-details');
        if (!paymentField) return false;
        if (isPackingMode()) {
            paymentField.value = '';
            lastAutoPaymentDetails = '';
            paymentDetailsDirty = false;
            return false;
        }
        const shipperId = D('shipper-select').value;
        const defaultDetails = getDefaultPaymentDetails(shipperId);
        const shouldUpdate = options.force || !paymentDetailsDirty || paymentField.value === lastAutoPaymentDetails;
        lastAutoPaymentDetails = defaultDetails;
        if (shouldUpdate) {
            paymentField.value = defaultDetails || '';
            paymentDetailsDirty = false;
            return true;
        }
        return false;
    }

    function renderRevisionTable(coreId, highlightRevision = currentRevisionLoaded) {
        const container = D('revision-history');
        const body = D('revision-table-body');
        if (!container || !body) return;

        if (!coreId) {
            body.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-2">No revisions yet / æš‚æ— ä¿®è®¢</td></tr>';
            body.dataset.base = '';
            body.dataset.docType = getDocumentMode();
            latestStoredRevision = '';
            currentRevisionLoaded = '';
            setEditingLocked(false);
            updateRevisionIndicator(latestStoredRevision);
            lastRenderedRevisionBase = '';
            updateNewRevisionButtonState();
            return;
        }

        const docType = getDocumentMode();
        const revisions = storage.getDocument(coreId, docType) || {};
        const revisionKeys = Object.keys(revisions).sort();
        if (revisionKeys.length === 0) {
            body.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400 py-2">No revisions yet / æš‚æ— ä¿®è®¢</td></tr>';
            body.dataset.base = coreId;
            body.dataset.docType = docType;
            latestStoredRevision = '';
            currentRevisionLoaded = '';
            setEditingLocked(false);
            updateRevisionIndicator(latestStoredRevision);
            lastRenderedRevisionBase = coreId;
            updateNewRevisionButtonState();
            return;
        }

        latestStoredRevision = revisionKeys[revisionKeys.length - 1] || 'A';
        const effectiveHighlight = highlightRevision || currentRevisionLoaded || latestStoredRevision || '';
        const rows = revisionKeys.map(revisionKey => {
            const revisionData = revisions[revisionKey];
            const savedDisplay = formatDateTimeDisplay(revisionData?.savedAt);
            const classes = ['revision-row'];
            if (revisionKey === effectiveHighlight) classes.push('is-selected');
            if (revisionKey === latestStoredRevision) classes.push('is-latest');
            return `<tr data-revision="${revisionKey}" class="${classes.join(' ')}"><td class="px-2 py-1">${revisionKey}</td><td class="px-2 py-1 text-gray-500">${savedDisplay}</td><td class="px-2 py-1 text-right"><button type="button" data-revision-delete="${revisionKey}">åˆ é™¤ Delete</button></td></tr>`;
        }).join('');

        body.innerHTML = rows;
        body.dataset.base = coreId;
        body.dataset.docType = docType;
        lastRenderedRevisionBase = coreId;
        currentRevisionLoaded = effectiveHighlight;
        updateRevisionIndicator(latestStoredRevision);
        updateNewRevisionButtonState();
    }

    function updateRevisionIndicator(latestRevision = '') {
        const indicator = D('invoice-version-indicator');
        if (!indicator) return;
        const currentParts = composeInvoiceParts();
        const currentRev = (currentParts.version || 'A').toUpperCase();
        const storedLatest = (latestRevision || latestStoredRevision || '').toUpperCase();
        const isViewing = editingLocked && storedLatest && storedLatest !== currentRev;

        const icon = editingLocked ? 'ğŸ”’' : 'âœ³ï¸';
        const label = editingLocked ? 'æŸ¥çœ‹ä¿®è®¢ Viewing Revision' : 'å½“å‰ä¿®è®¢ Current Revision';
        let html = `<span class="indicator-label">${icon} ${label}</span><span class="indicator-value">${currentRev}</span>`;
        if (storedLatest) {
            const latestLabel = storedLatest !== currentRev ? 'æœ€æ–°ä¿å­˜ Latest Saved' : 'å·²ä¿å­˜ Saved';
            html += `<span class="indicator-extra">${latestLabel}: <strong>${storedLatest}</strong></span>`;
        }
        indicator.innerHTML = html;
        indicator.classList.toggle('is-locked', editingLocked);
        indicator.classList.toggle('is-stale', Boolean(storedLatest && storedLatest !== currentRev));

        const banner = D('editing-lock-banner');
        if (banner) {
            banner.classList.toggle('hidden', !isViewing);
        }
        updateConfirmAndActionButtons();
    }

    function setEditingLocked(flag) {
        if (editingLocked === flag) {
            updateConfirmAndActionButtons();
            return;
        }
        editingLocked = flag;
        const form = D('form-container');
        if (form) {
            const elements = form.querySelectorAll('input, textarea, select, button');
            elements.forEach((el) => {
                if (el.closest('#revision-history')) return;
                if (['open-printable-html-btn', 'manage-shippers-btn'].includes(el.id)) return;
                // Allow document-mode switching even when locked
                if (el.name === 'document-mode') return;
                if (flag) {
                    if (!el.dataset.lockAware) {
                        el.dataset.lockAware = '1';
                        el.dataset.lockOriginalDisabled = el.disabled ? '1' : '0';
                    }
                    el.disabled = true;
                } else if (el.dataset.lockAware === '1') {
                    if (el.dataset.lockOriginalDisabled === '0') {
                        el.disabled = false;
                    }
                    delete el.dataset.lockAware;
                    delete el.dataset.lockOriginalDisabled;
                }
            });
        }
        if (!flag) {
            revisionConfirmed = false;
        } else if (!revisionConfirmed) {
            revisionConfirmed = Boolean(currentRevisionLoaded || latestStoredRevision);
        }
        updateRevisionIndicator();
    }

    function updateNewRevisionButtonState() {
        if (!newRevisionBtn) return;
        const parts = composeInvoiceParts();
        const revisions = parts.base ? storage.getDocument(parts.base, getDocumentMode()) : null;
        const hasSaved = Boolean(revisions && Object.keys(revisions).length);
        newRevisionBtn.classList.toggle('hidden', !hasSaved);
        newRevisionBtn.disabled = !hasSaved || !editingLocked;
    }

    function updateConfirmAndActionButtons() {
        if (confirmRevisionBtn) {
            const shouldShow = !editingLocked;
            confirmRevisionBtn.classList.toggle('hidden', !shouldShow);
            confirmRevisionBtn.disabled = revisionConfirmed || !shouldShow;
        }
        updateNewRevisionButtonState();
        const allowActions = editingLocked && (revisionConfirmed || Boolean(latestStoredRevision));
        const actionButtons = [D('open-printable-html-btn')];
        actionButtons.forEach(btn => {
            if (!btn) return;
            btn.disabled = !allowActions;
        });
    }

    function confirmActiveRevision() {
        if (!confirmRevisionBtn || confirmRevisionBtn.dataset.processing === '1') return;
        confirmRevisionBtn.dataset.processing = '1';
        confirmRevisionBtn.disabled = true;
        try {
            const dataToSave = collectFormData({ finalizeAmounts: true });
            if (!dataToSave.coreId || dataToSave.coreId === 'QHD-INV') {
                showToast('è¯·å…ˆå¡«å†™å®Œæ•´çš„å‘ç¥¨ç¼–å·åå†ç¡®è®¤ä¿®è®¢');
                confirmRevisionBtn.disabled = false;
                return;
            }
            storage.saveDocument(dataToSave);
            latestStoredRevision = dataToSave.version || 'A';
            currentRevisionLoaded = latestStoredRevision;
            renderRevisionTable(dataToSave.invoiceBaseNo, currentRevisionLoaded);
            updateRevisionIndicator(latestStoredRevision);
            setEditingLocked(true);
            updateAllPreviews();
            // Refresh saved invoices list for packing list reference
            if (dataToSave.documentType === 'invoice') {
                populateSavedInvoices();
            }
            showToast(`ä¿®è®¢ Revision ${latestStoredRevision} å·²ç¡®è®¤!`);
        } catch (error) {
            console.error('Confirm revision failed:', error);
            showToast('ä¿®è®¢ç¡®è®¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            setEditingLocked(false);
            confirmRevisionBtn.disabled = false;
        } finally {
            delete confirmRevisionBtn.dataset.processing;
            if (!editingLocked) {
                confirmRevisionBtn.disabled = false;
            }
        }
    }

    function getNextSequenceForDateSegment(segment, docType = getDocumentMode()) {
        if (!segment) return '01';
        let maxSeq = 0;
        const docPrefix = docType === 'packing' ? 'QHD-PL' : 'QHD-INV';
        const storagePrefix = docType === 'packing' ? 'packing_' : 'invoice_';
        const prefix = `${docPrefix}-${segment}`;
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key || !key.startsWith(storagePrefix)) continue;
            const coreId = key.slice(storagePrefix.length);
            if (!coreId.startsWith(prefix)) continue;
            const parts = coreId.split('-');
            if (parts.length < 3) continue;
            let seqVal = 0;
            if (parts.length >= 4 && /^\d+$/.test(parts[3])) {
                seqVal = parseInt(parts[3], 10);
            }
            if (seqVal > maxSeq) maxSeq = seqVal;
        }
        const seqKeyPrefix = docType === 'packing' ? 'packingSeq_' : 'invoiceSeq_';
        const trackedKey = `${seqKeyPrefix}${segment}`;
        const trackedValue = parseInt(localStorage.getItem(trackedKey) || '0', 10);
        if (Number.isFinite(trackedValue) && trackedValue > maxSeq) {
            maxSeq = trackedValue;
        }
        const nextSeq = Math.max(0, maxSeq) + 1;
        localStorage.setItem(trackedKey, String(nextSeq));
        return String(nextSeq).padStart(2, '0');
    }

    function getNextVersionLetter(current) {
        const value = (current || '').trim().toUpperCase();
        if (!value) return 'A';
        if (!/^[A-Z]+$/.test(value)) return 'A';
        const letters = value.split('');
        for (let i = letters.length - 1; i >= 0; i--) {
            const code = letters[i].charCodeAt(0);
            if (code < 90) {
                letters[i] = String.fromCharCode(code + 1);
                return letters.slice(0, i + 1).join('') + letters.slice(i + 1).map(() => 'A').join('');
            }
            letters[i] = 'A';
        }
        return 'A' + letters.join('');
    }

    function syncInvoiceSequence(options = { force: false }) {
        const seqInput = D('invoice-seq');
        const segmentInput = D('invoice-date-segment');
        if (!seqInput || !segmentInput) return false;
        const segment = segmentInput.value.trim().slice(0, 8);
        if (!segment) return false;
        const shouldUpdate = options.force || !invoiceSeqDirty || seqInput.value === lastAutoDocumentSeq;
        if (!shouldUpdate) return false;
        const docType = getDocumentMode();
        const nextSeq = getNextSequenceForDateSegment(segment, docType);
        lastAutoDocumentSeq = nextSeq;
        if (seqInput.value !== nextSeq) seqInput.value = nextSeq;
        invoiceSeqDirty = false;
        latestStoredRevision = '';
        updateRevisionIndicator(latestStoredRevision);
        return true;
    }

    function syncInvoiceVersion(options = { force: false, defaultVersion: 'A' }) {
        const versionInput = D('invoice-version');
        if (!versionInput) return false;
        const desired = (options.defaultVersion || 'A').trim().toUpperCase() || 'A';
        const shouldUpdate = options.force || !invoiceVersionDirty || versionInput.value.toUpperCase() === lastAutoInvoiceVersion;
        if (!shouldUpdate) return false;
        lastAutoInvoiceVersion = desired;
        if (versionInput.value !== desired) versionInput.value = desired;
        invoiceVersionDirty = false;
        return true;
    }

    const storage = {
        getShippers: () => JSON.parse(localStorage.getItem('invoiceShippers_v3')) || defaultShipperProfiles,
        saveShippers: (profiles) => localStorage.setItem('invoiceShippers_v3', JSON.stringify(profiles)),
        getConsignees: () => JSON.parse(localStorage.getItem('invoiceConsignees_v1')) || {},
        saveConsignees: (profiles) => localStorage.setItem('invoiceConsignees_v1', JSON.stringify(profiles)),
        getBillTo: () => JSON.parse(localStorage.getItem('invoiceBillTo_v1')) || {},
        saveBillTo: (profiles) => localStorage.setItem('invoiceBillTo_v1', JSON.stringify(profiles)),
        getStorageKey(coreId, docType = getDocumentMode()) {
            const prefix = docType === 'packing' ? 'packing_' : 'invoice_';
            return `${prefix}${coreId}`;
        },
        getDocument(coreId, docType = getDocumentMode()) {
            if (!coreId) return null;
            const key = this.getStorageKey(coreId, docType);
            return JSON.parse(localStorage.getItem(key));
        },
        saveDocument(versionedData) {
            const coreId = versionedData.coreId;
            const version = versionedData.version;
            const docType = versionedData.documentType || getDocumentMode();
            const key = this.getStorageKey(coreId, docType);
            const existing = this.getDocument(coreId, docType) || {};
            versionedData.savedAt = versionedData.savedAt || new Date().toISOString();
            versionedData.invoiceBaseNo = versionedData.invoiceBaseNo || coreId;
            versionedData.documentType = docType;
            existing[version] = versionedData;
            localStorage.setItem(key, JSON.stringify(existing));
        },
        deleteRevision(coreId, revisionKey, docType = getDocumentMode()) {
            if (!coreId || !revisionKey) return null;
            const key = this.getStorageKey(coreId, docType);
            const revisions = this.getDocument(coreId, docType) || {};
            if (!revisions[revisionKey]) return revisions;
            delete revisions[revisionKey];
            const remainingKeys = Object.keys(revisions);
            if (remainingKeys.length === 0) {
                localStorage.removeItem(key);
                return {};
            }
            localStorage.setItem(key, JSON.stringify(revisions));
            return revisions;
        }
    };

    function deleteStoredRevision(coreId, revisionKey) {
        return storage.deleteRevision(coreId, revisionKey, getDocumentMode());
    }

    function populateSavedInvoices() {
        const datalist = D('saved-invoices-list');
        if (!datalist) return;

        datalist.innerHTML = '';
        const invoiceKeys = [];

        // Scan localStorage for all saved invoices
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('invoice_')) {
                const coreId = key.slice('invoice_'.length);
                if (coreId.startsWith('QHD-INV-')) {
                    invoiceKeys.push(coreId);
                }
            }
        }

        // Sort by date (newest first) - format is QHD-INV-YYYYMMDD-NN
        invoiceKeys.sort((a, b) => {
            const dateA = a.split('-')[2] || '00000000';
            const dateB = b.split('-')[2] || '00000000';
            return dateB.localeCompare(dateA);
        });

        // Add options to datalist
        invoiceKeys.forEach(coreId => {
            const option = document.createElement('option');
            option.value = coreId;
            datalist.appendChild(option);
        });
    }

    const profileManager = {
        init() {
            D('manage-shippers-btn').addEventListener('click', () => this.show());
            D('save-profile').addEventListener('click', () => this.save());
            D('cancel-profile-edit').addEventListener('click', () => this.hide());
        },
        show() { this.renderList(); this.resetForm(); D('shipper-profile-manager').classList.remove('hidden'); },
        hide() { D('shipper-profile-manager').classList.add('hidden'); },
        renderList() {
            const listEl = D('shipper-profile-list');
            listEl.innerHTML = '';
            Object.keys(shipperProfiles).forEach(id => {
                const isDefault = Object.keys(defaultShipperProfiles).includes(id);
                listEl.innerHTML += `<div class="flex items-center justify-between bg-gray-100 p-2 rounded"><span>${shipperProfiles[id].name}</span><div><button class="edit-profile text-blue-500 mr-2" data-id="${id}">ç¼–è¾‘</button>${!isDefault ? `<button class="delete-profile text-red-500" data-id="${id}">åˆ é™¤</button>` : ''}</div></div>`;
            });
            listEl.querySelectorAll('.edit-profile').forEach(b => b.addEventListener('click', (e) => this.edit(e.target.dataset.id)));
            listEl.querySelectorAll('.delete-profile').forEach(b => b.addEventListener('click', (e) => this.delete(e.target.dataset.id)));
        },
        resetForm() { D('profile-editor-title').textContent = 'æ·»åŠ æ–°å‘è´§æ–¹'; ['profile-id', 'profile-name', 'profile-address', 'profile-bank'].forEach(id => D(id).value = ''); },
        edit(id) {
            const p = shipperProfiles[id];
            D('profile-editor-title').textContent = 'ç¼–è¾‘å‘è´§æ–¹';
            D('profile-id').value = id; D('profile-name').value = p.name;
            D('profile-address').value = p.address; D('profile-bank').value = p.bankDetails;
        },
        save() {
            const id = D('profile-id').value || 'custom-' + Date.now();
            const name = D('profile-name').value.trim();
            if (!name) { alert('åç§°ä¸èƒ½ä¸ºç©º'); return; }
            shipperProfiles[id] = { name, address: D('profile-address').value, bankDetails: D('profile-bank').value };
            storage.saveShippers(shipperProfiles);
            populateShipperSelect();
            D('shipper-select').value = id;
            D('shipper-select').dispatchEvent(new Event('change'));
            this.hide();
        },
        delete(id) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${shipperProfiles[id].name}" å—ï¼Ÿ`)) {
                delete shipperProfiles[id];
                storage.saveShippers(shipperProfiles);
                populateShipperSelect();
                D('shipper-select').dispatchEvent(new Event('change'));
                this.renderList();
            }
        }
    };

    const consigneeManager = {
        init() {
            D('manage-consignees-btn').addEventListener('click', () => this.show());
            D('save-consignee').addEventListener('click', () => this.save());
            D('cancel-consignee-edit').addEventListener('click', () => this.hide());
        },
        show() { this.renderList(); this.resetForm(); D('consignee-profile-manager').classList.remove('hidden'); },
        hide() { D('consignee-profile-manager').classList.add('hidden'); },
        renderList() {
            const listEl = D('consignee-profile-list');
            listEl.innerHTML = '';
            Object.keys(consigneeProfiles).forEach(id => {
                listEl.innerHTML += `<div class="flex items-center justify-between bg-gray-100 p-2 rounded"><span>${consigneeProfiles[id].name}</span><div><button class="edit-consignee text-blue-500 mr-2" data-id="${id}">ç¼–è¾‘</button><button class="delete-consignee text-red-500" data-id="${id}">åˆ é™¤</button></div></div>`;
            });
            listEl.querySelectorAll('.edit-consignee').forEach(btn => btn.addEventListener('click', () => this.edit(btn.dataset.id)));
            listEl.querySelectorAll('.delete-consignee').forEach(btn => btn.addEventListener('click', () => this.delete(btn.dataset.id)));
        },
        resetForm() {
            D('consignee-profile-id').value = '';
            D('consignee-profile-name').value = '';
            D('consignee-profile-address').value = '';
            D('consignee-editor-title').textContent = 'æ·»åŠ æ–°æ”¶è´§äºº';
        },
        edit(id) {
            const p = consigneeProfiles[id];
            D('consignee-profile-id').value = id;
            D('consignee-profile-name').value = p.name;
            D('consignee-profile-address').value = p.address;
            D('consignee-editor-title').textContent = 'ç¼–è¾‘æ”¶è´§äºº';
        },
        save() {
            const id = D('consignee-profile-id').value || 'consignee-' + Date.now();
            const name = D('consignee-profile-name').value.trim();
            if (!name) { alert('åç§°ä¸èƒ½ä¸ºç©º'); return; }
            consigneeProfiles[id] = { name, address: D('consignee-profile-address').value };
            storage.saveConsignees(consigneeProfiles);
            populateConsigneeSelect();
            D('consignee-select').value = id;
            D('consignee-select').dispatchEvent(new Event('change'));
            this.hide();
        },
        delete(id) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${consigneeProfiles[id].name}" å—ï¼Ÿ`)) {
                delete consigneeProfiles[id];
                storage.saveConsignees(consigneeProfiles);
                populateConsigneeSelect();
                D('consignee-select').dispatchEvent(new Event('change'));
                this.renderList();
            }
        }
    };

    const billToManager = {
        init() {
            D('manage-billto-btn').addEventListener('click', () => this.show());
            D('save-billto').addEventListener('click', () => this.save());
            D('cancel-billto-edit').addEventListener('click', () => this.hide());
        },
        show() { this.renderList(); this.resetForm(); D('billto-profile-manager').classList.remove('hidden'); },
        hide() { D('billto-profile-manager').classList.add('hidden'); },
        renderList() {
            const listEl = D('billto-profile-list');
            listEl.innerHTML = '';
            Object.keys(billToProfiles).forEach(id => {
                listEl.innerHTML += `<div class="flex items-center justify-between bg-gray-100 p-2 rounded"><span>${billToProfiles[id].name}</span><div><button class="edit-billto text-blue-500 mr-2" data-id="${id}">ç¼–è¾‘</button><button class="delete-billto text-red-500" data-id="${id}">åˆ é™¤</button></div></div>`;
            });
            listEl.querySelectorAll('.edit-billto').forEach(btn => btn.addEventListener('click', () => this.edit(btn.dataset.id)));
            listEl.querySelectorAll('.delete-billto').forEach(btn => btn.addEventListener('click', () => this.delete(btn.dataset.id)));
        },
        resetForm() {
            D('billto-profile-id').value = '';
            D('billto-profile-name').value = '';
            D('billto-profile-address').value = '';
            D('billto-editor-title').textContent = 'æ·»åŠ æ–°ä»˜æ¬¾æ–¹';
        },
        edit(id) {
            const p = billToProfiles[id];
            D('billto-profile-id').value = id;
            D('billto-profile-name').value = p.name;
            D('billto-profile-address').value = p.address;
            D('billto-editor-title').textContent = 'ç¼–è¾‘ä»˜æ¬¾æ–¹';
        },
        save() {
            const id = D('billto-profile-id').value || 'billto-' + Date.now();
            const name = D('billto-profile-name').value.trim();
            if (!name) { alert('åç§°ä¸èƒ½ä¸ºç©º'); return; }
            billToProfiles[id] = { name, address: D('billto-profile-address').value };
            storage.saveBillTo(billToProfiles);
            populateBillToSelect();
            D('billto-select').value = id;
            D('billto-select').dispatchEvent(new Event('change'));
            this.hide();
        },
        delete(id) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${billToProfiles[id].name}" å—ï¼Ÿ`)) {
                delete billToProfiles[id];
                storage.saveBillTo(billToProfiles);
                populateBillToSelect();
                D('billto-select').dispatchEvent(new Event('change'));
                this.renderList();
            }
        }
    };

    const formatDate = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

    const formatDisplayDate = (dateStr) => {
        if (!dateStr) return '';
        try {
            // Parse date more reliably to avoid timezone issues
            const dateParts = dateStr.split('-');
            if (dateParts.length === 3) {
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1; // months are 0-indexed
                const day = parseInt(dateParts[2], 10);
                const date = new Date(year, month, day);
                return date.toLocaleDateString('en-US');
            }
            return '';
        } catch (error) {
            console.warn('Date parsing error:', error);
            return '';
        }
    };

    const formatDateTimeDisplay = (isoString) => {
        if (!isoString) return 'Unknown';
        try {
            const date = new Date(isoString);
            if (Number.isNaN(date.getTime())) return 'Unknown';
            return date.toLocaleString('zh-CN', { hour12: false });
        } catch (error) {
            return 'Unknown';
        }
    };
    
    function createSelectWithOptions(id, config) {
        const select = D(id + '-select');
        select.innerHTML = [...config.options, 'Custom'].map(o => `<option value="${o}">${o}</option>`).join('');
        select.value = config.default;
        select.addEventListener('change', () => {
            D(id + '-custom').classList.toggle('hidden', select.value !== 'Custom');
            updateAllPreviews();
        });
    }

    function autoFitPreview() {
        const wrapper = Q('.preview-wrapper');
        const preview = D('invoice-preview');
        if (!wrapper || !preview || preview.offsetWidth === 0) return;
        const scale = wrapper.offsetWidth / preview.offsetWidth;
        preview.style.transform = `scale(${scale})`;
        wrapper.style.height = `${preview.offsetHeight * scale}px`;
    }
    
    function updateAllPreviews() {
        switchTemplate();
        updateDocumentUI();
        const data = collectFormData();
        const docType = data.documentType || getDocumentMode();
        const isInvoiceDoc = docType === 'invoice';
        const dueDate = isInvoiceDoc ? calculateDueDate(data.date, data.paymentTerms) : '';

        const targets = {
            'date': formatDisplayDate(data.date),
            'order-no': data['order-no'],
            'payment-due-date': dueDate,
            'payment-terms': isInvoiceDoc ? data.paymentTerms : '',
            'incoterms': isInvoiceDoc ? data.incoterms : '',
            'shipper': (shipperProfiles[data.shipper]?.name ? shipperProfiles[data.shipper].name + '\n' : '') + (shipperProfiles[data.shipper]?.address || ''),
            'consignee': (consigneeProfiles[data.consignee]?.name ? consigneeProfiles[data.consignee].name + '\n' : '') + (consigneeProfiles[data.consignee]?.address || ''),
            'bill-to': (billToProfiles[data.billTo]?.name ? billToProfiles[data.billTo].name + '\n' : '') + (billToProfiles[data.billTo]?.address || ''),
            'notify-party': isInvoiceDoc ? (data['notify-party'] || 'SAME AS CONSIGNEE') : '',
            'country-of-origin': isInvoiceDoc ? data.countryOfOrigin : '',
            'currency': data.currency,
            'bank-details': isInvoiceDoc ? (data.paymentDetails || '') : '',
            'invoice-title': data.invoiceType,
            'preview-invoice-base': data.invoiceBaseNo,
            'preview-invoice-revision': data.revision,
            'packing-marks': docType === 'packing' ? data.packingMarks : '',
            'packing-notes': docType === 'packing' ? data.packingNotes : '',
            'packing-invoice-reference': docType === 'packing' ? data.packingInvoiceRef : '',
            'identity-label-primary': docType === 'packing' ? 'Packing List No.' : 'Invoice No.'
        };

        for (const [targetId, value] of Object.entries(targets)) {
            const el = Q(`[data-target="${targetId}"]`);
            if (el) el.textContent = value || '';
        }
        if (docType !== 'packing') {
            ['pl-total-packages', 'pl-total-qty', 'pl-total-net', 'pl-total-gross', 'pl-total-volume'].forEach(id => {
                const el = Q(`[data-target="${id}"]`);
                if (el) el.textContent = '';
            });
        }
        const baseDisplay = D('invoice-base-display');
        if (baseDisplay) {
            baseDisplay.textContent = `Base No. åŸºç¡€ç¼–å·: ${data.invoiceBaseNo || 'N/A'}`;
        }
        updateItemsAndTotals();
        if (data.invoiceBaseNo && data.invoiceBaseNo !== lastRenderedRevisionBase) {
            currentRevisionLoaded = '';
            renderRevisionTable(data.invoiceBaseNo, currentRevisionLoaded);
        }
        updateRevisionIndicator(latestStoredRevision);
        updateNewRevisionButtonState();
    }

    // Package-based Packing List Functions
    function calculateCBM(dimensions) {
        if (!dimensions) return 0;
        const match = dimensions.match(/(\d+\.?\d*)\s*[Ã—xX*]\s*(\d+\.?\d*)\s*[Ã—xX*]\s*(\d+\.?\d*)/);
        if (!match) return 0;
        const l = parseFloat(match[1]);
        const w = parseFloat(match[2]);
        const h = parseFloat(match[3]);
        if (!Number.isFinite(l) || !Number.isFinite(w) || !Number.isFinite(h)) return 0;
        return (l * w * h) / 1000000; // convert cmÂ³ to mÂ³
    }

    function addPackageItem(packageId, data = {}) {
        const packageEl = D(packageId);
        if (!packageEl) return;

        const itemsContainer = packageEl.querySelector('.package-items-container');
        if (!itemsContainer) return;

        itemCounter++;
        const itemId = `package-item-${itemCounter}`;
        const qtyValue = data.qty !== undefined ? data.qty : 0;
        const netWtValue = data.netWt !== undefined ? data.netWt : '0.00';
        const netWtDisplay = Number.isFinite(parseFloat(netWtValue)) ? (parseFloat(netWtValue).toFixed(2)) : '0.00';
        const uomOptions = [...optionConfigs.uom.options, 'Custom'].map(o => `<option value="${o}" ${o === (data.uom || optionConfigs.uom.default) ? 'selected' : ''}>${o}</option>`).join('');

        const itemHtml = `
            <div id="${itemId}" class="package-item p-3 border border-gray-200 rounded bg-gray-50 relative mb-2">
                <button class="remove-package-item-btn absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold text-sm">âœ–</button>
                <div class="grid grid-cols-1 gap-3">
                    <div><label class="text-xs font-medium">è´§ç‰©æè¿° Description</label><textarea data-item-prop="description" rows="2" class="form-input mt-1 text-sm">${data.description || ''}</textarea></div>
                    <div><label class="text-xs font-medium">HS CODE ç¨åˆ™å·</label><input type="text" data-item-prop="hscode" class="form-input mt-1 text-sm" value="${data.hscode || ''}"></div>
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-xs font-medium">æ•°é‡ QTY</label><input type="number" data-item-prop="qty" class="form-input mt-1 text-sm" value="${qtyValue}"></div>
                        <div><label class="text-xs font-medium">å•ä½ UOM</label><div class="custom-combo mt-1"><select class="form-select text-sm uom-select">${uomOptions}</select><input type="text" data-item-prop="uom-custom" class="form-input hidden text-sm uom-custom"></div></div>
                        <div><label class="text-xs font-medium">å‡€é‡ (KG) NET WT</label><input type="number" step="0.01" data-item-prop="netWt" class="form-input mt-1 text-sm" value="${netWtDisplay}"></div>
                    </div>
                </div>
            </div>`;

        itemsContainer.insertAdjacentHTML('beforeend', itemHtml);

        const itemEl = D(itemId);
        const uomSelect = itemEl.querySelector('.uom-select');
        const uomCustom = itemEl.querySelector('.uom-custom');

        if (uomSelect && uomCustom) {
            uomSelect.addEventListener('change', function() {
                uomCustom.classList.toggle('hidden', this.value !== 'Custom');
                updateAllPreviews();
            });

            if (data.uom && !optionConfigs.uom.options.includes(data.uom)) {
                uomSelect.value = 'Custom';
                uomCustom.value = data.uom;
                uomCustom.classList.remove('hidden');
            } else {
                uomSelect.dispatchEvent(new Event('change'));
            }
        }

        updateAllPreviews();
    }

    function addNewPackage(data = {}) {
        packageCounter++;
        const packageId = `package-${packageCounter}`;
        const packageTypeOptions = [...optionConfigs.packageType.options, 'Custom'].map(o => `<option value="${o}" ${o === (data.packageType || optionConfigs.packageType.default) ? 'selected' : ''}>${o}</option>`).join('');
        const grossWtValue = data.grossWt !== undefined ? data.grossWt : '0.00';
        const grossWtDisplay = Number.isFinite(parseFloat(grossWtValue)) ? (parseFloat(grossWtValue).toFixed(2)) : '0.00';
        const dimensionsValue = data.dimensions !== undefined ? data.dimensions : '';
        const packagesValue = data.packages !== undefined ? data.packages : 1;
        const cbm = calculateCBM(dimensionsValue);
        const cbmDisplay = cbm.toFixed(3);

        const packageHtml = `
            <div id="${packageId}" class="package-card p-4 border-2 rounded-lg bg-white relative mb-4">
                <button class="remove-package-btn absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold">âœ–</button>
                <p class="font-semibold text-gray-800 mb-3">ğŸ“¦ åŒ…è£… Package #${packageCounter}</p>
                <div class="grid grid-cols-1 gap-3 mb-3">
                    <div class="grid grid-cols-4 gap-3">
                        <div><label class="text-sm font-medium">ä»¶æ•° Quantity</label><input type="number" step="1" min="1" data-package-prop="packages" class="form-input mt-1" value="${packagesValue}"></div>
                        <div><label class="text-sm font-medium">åŒ…è£…ç±»å‹ Type</label><div class="custom-combo mt-1"><select class="form-select package-type-select">${packageTypeOptions}</select><input type="text" data-package-prop="packageType-custom" class="form-input hidden package-type-custom"></div></div>
                        <div><label class="text-sm font-medium">å°ºå¯¸ (cm) LÃ—WÃ—H</label><input type="text" data-package-prop="dimensions" class="form-input mt-1 dimensions-input" placeholder="120Ã—80Ã—100" value="${dimensionsValue}"></div>
                        <div><label class="text-sm font-medium">å•ç®±æ¯›é‡ (KG) Unit Gross WT</label><input type="number" step="0.01" data-package-prop="grossWt" class="form-input mt-1" value="${grossWtDisplay}"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-sm font-medium">å•ç®±ä½“ç§¯ (CBM) Unit Measurement</label><input type="number" step="0.001" data-package-prop="cbm" class="form-input mt-1 cbm-display" value="${cbmDisplay}" readonly style="background-color: #f9fafb;"></div>
                        <div><label class="text-sm font-medium">æ€»è®¡ Total</label><div class="form-input mt-1 bg-green-50 font-semibold package-total-display" style="background-color: #f0fdf4; color: #15803d; border-color: #86efac;">æ¯›é‡ ${(parseFloat(grossWtDisplay) * packagesValue).toFixed(2)} KG | ä½“ç§¯ ${(cbm * packagesValue).toFixed(3)} CBM</div></div>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <p class="text-sm font-medium text-gray-700 mb-2">åŒ…è£…å†…è´§ç‰© Items in this Package:</p>
                    <div class="package-items-container"></div>
                    <button class="add-package-item-btn mt-2 bg-blue-400 hover:bg-blue-500 text-white text-sm font-medium py-1 px-3 rounded">+ æ·»åŠ è´§ç‰© Add Item</button>
                </div>
            </div>`;

        D('items-container').insertAdjacentHTML('beforeend', packageHtml);

        const packageEl = D(packageId);
        const packageTypeSelect = packageEl.querySelector('.package-type-select');
        const packageTypeCustom = packageEl.querySelector('.package-type-custom');
        const dimensionsInput = packageEl.querySelector('.dimensions-input');
        const cbmDisplayEl = packageEl.querySelector('.cbm-display');
        const packagesInput = packageEl.querySelector('[data-package-prop="packages"]');
        const grossWtInput = packageEl.querySelector('[data-package-prop="grossWt"]');
        const totalDisplayEl = packageEl.querySelector('.package-total-display');

        // Function to update total display
        const updateTotalDisplay = () => {
            const packages = parseInt(packagesInput.value) || 1;
            const grossWt = parseFloat(grossWtInput.value) || 0;
            const cbm = parseFloat(cbmDisplayEl.value) || 0;
            const totalGrossWt = (grossWt * packages).toFixed(2);
            const totalCbm = (cbm * packages).toFixed(3);
            totalDisplayEl.textContent = `æ¯›é‡ ${totalGrossWt} KG | ä½“ç§¯ ${totalCbm} CBM`;
        };

        // Package type select handler
        if (packageTypeSelect && packageTypeCustom) {
            packageTypeSelect.addEventListener('change', function() {
                packageTypeCustom.classList.toggle('hidden', this.value !== 'Custom');
                updateAllPreviews();
            });

            if (data.packageType && !optionConfigs.packageType.options.includes(data.packageType)) {
                packageTypeSelect.value = 'Custom';
                packageTypeCustom.value = data.packageType;
                packageTypeCustom.classList.remove('hidden');
            } else {
                packageTypeSelect.dispatchEvent(new Event('change'));
            }
        }

        // Dimensions auto-calculate CBM and update total
        if (dimensionsInput && cbmDisplayEl) {
            dimensionsInput.addEventListener('input', function() {
                const cbm = calculateCBM(this.value);
                cbmDisplayEl.value = cbm.toFixed(3);
                updateTotalDisplay();
                updateAllPreviews();
            });
        }

        // Packages quantity change handler
        if (packagesInput) {
            packagesInput.addEventListener('input', function() {
                updateTotalDisplay();
                updateAllPreviews();
            });
        }

        // Gross weight change handler
        if (grossWtInput) {
            grossWtInput.addEventListener('input', function() {
                updateTotalDisplay();
                updateAllPreviews();
            });
        }

        // Add item button
        packageEl.querySelector('.add-package-item-btn').addEventListener('click', () => {
            addPackageItem(packageId);
        });

        // Load existing items
        if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => addPackageItem(packageId, item));
        }

        updateAllPreviews();
    }

    function calculateDueDate(dateStr, terms) {
        if (!dateStr || !terms) return 'N/A';
        if (terms.toLowerCase().includes('advance')) return formatDisplayDate(dateStr);
        const daysMatch = terms.match(/\d+/);
        if (daysMatch) {
            try {
                const dateParts = dateStr.split('-');
                if (dateParts.length === 3) {
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1;
                    const day = parseInt(dateParts[2], 10);
                    let dueDate = new Date(year, month, day);
                    dueDate.setDate(dueDate.getDate() + parseInt(daysMatch[0], 10));
                    return formatDisplayDate(formatDate(dueDate));
                }
            } catch (error) {
                console.warn('Due date calculation error:', error);
            }
        }
        return 'N/A';
    }
    
    function getCurrentCoreId() {
        const segment = D('invoice-date-segment').value.trim().replace(/[^0-9]/g, '').slice(0, 8);
        if (!segment) return null;
        const seqRaw = String(D('invoice-seq').value || '').trim();
        const docPrefix = getDocumentPrefix();
        const base = `${docPrefix}-${segment}`;
        if (!seqRaw) return base;
        const seq = /^\d+$/.test(seqRaw) ? seqRaw.padStart(2, '0') : seqRaw;
        return `${base}-${seq}`;
    }

    function composeInvoiceParts() {
        const segment = D('invoice-date-segment').value.trim().replace(/[^0-9]/g, '').slice(0, 8);
        const seqRaw = String(D('invoice-seq').value || '').trim();
        const versionRaw = String(D('invoice-version').value || '').trim();
        const prefix = getDocumentPrefix();
        const baseParts = prefix.split('-');
        const parts = [...baseParts];
        if (segment) parts.push(segment);
        if (seqRaw) {
            const normalizedSeq = /^\d+$/.test(seqRaw) ? seqRaw.padStart(2, '0') : seqRaw;
            parts.push(normalizedSeq);
        }
        const base = parts.join('-');
        const version = versionRaw ? versionRaw.toUpperCase() : '';
        const full = version ? `${base}-${version}` : base;
        return { base, version, full };
    }

    function composeInvoiceNumber() {
        return composeInvoiceParts().full;
    }

    function startNewRevision() {
        const versionInput = D('invoice-version');
        const baseParts = composeInvoiceParts();
        if (!baseParts.base) return;
        if (latestStoredRevision) {
            const latest = latestStoredRevision.toUpperCase();
            if (currentRevisionLoaded !== latest) {
                loadRevisionFromStorage(baseParts.base, latest, { autoIncrement: false });
            }
        }
        const nextRevision = getNextVersionLetter(latestStoredRevision || baseParts.version || 'A');
        if (versionInput) {
            versionInput.value = nextRevision;
            lastAutoInvoiceVersion = nextRevision;
            invoiceVersionDirty = false;
        }
        currentRevisionLoaded = '';
        setEditingLocked(false);
        updateRevisionIndicator();
        updateAllPreviews();
        updateNewRevisionButtonState();
    }

    function loadRevisionFromStorage(base, revisionKey, { autoIncrement = false } = {}) {
        if (!base || !revisionKey) return false;
        const revisions = storage.getDocument(base, getDocumentMode());
        if (!revisions || !revisions[revisionKey]) return false;
        currentRevisionLoaded = revisionKey;
        populateFormWithData(revisions[revisionKey], {
            latestRevision: latestStoredRevision,
            selectedRevision: revisionKey,
            autoIncrementRevision: autoIncrement
        });
        return true;
    }

    let itemCounter = 0;
    function addNewItem(data = {}) {
        itemCounter++;
        const uomOptions = [...optionConfigs.uom.options, 'Custom'].map(o => `<option value="${o}" ${o === (data.uom || optionConfigs.uom.default) ? 'selected' : ''}>${o}</option>`).join('');
        const qtyValue = data.qty !== undefined ? data.qty : 0;
        const unitPriceValue = data.unitPrice !== undefined ? data.unitPrice : '0.00000';
        const netWtValue = data.netWt !== undefined ? data.netWt : '0.00';
        const parsedAmount = parseAmountValue(data.amount);
        const computedDefaultAmount = computeItemAmount(qtyValue, unitPriceValue);
        const resolvedAmountNumber = parsedAmount !== null ? parsedAmount : computedDefaultAmount;
        const amountDisplay = Number.isFinite(resolvedAmountNumber) ? resolvedAmountNumber.toFixed(2) : '0.00';
        const amountMode = data.amountMode === 'manual' && parsedAmount !== null ? 'manual' : 'auto';
        const netWtDisplay = Number.isFinite(parseFloat(netWtValue)) ? (parseFloat(netWtValue).toFixed(2)) : '0.00';
        const unitPriceDisplay = Number.isFinite(parseFloat(unitPriceValue)) ? (parseFloat(unitPriceValue).toFixed(5)) : '0.00000';
        const fullItemHtml = `
            <div id="item-${itemCounter}" class="item-row p-4 border rounded-lg bg-white relative">
                <button class="remove-item-btn absolute top-2 right-2 text-red-500 hover:text-red-700 font-bold">âœ–</button>
                <p class="font-medium text-gray-800 mb-2">æ¡ç›® #${itemCounter}</p>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="text-sm">è´§ç‰©æè¿° Description</label><textarea data-item-prop="description" rows="2" class="form-input mt-1">${data.description || ''}</textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div data-doc="invoice" data-template="ci-only"><label class="text-sm">HS CODE ç¨åˆ™å·</label><input type="text" data-item-prop="hs-code" class="form-input mt-1" value="${data['hs-code'] || ''}"></div>
                        <div data-doc="invoice,packing" data-template="ci-only"><label class="text-sm">å‡€é‡ (KG) NET WT.</label><input type="number" step="0.01" data-item-prop="netWt" class="form-input mt-1" value="${netWtDisplay}"></div>
                        <div><label class="text-sm">æ•°é‡ QTY.</label><input type="number" data-item-prop="qty" class="form-input mt-1" value="${qtyValue}"></div>
                        <div><label class="text-sm">å•ä½ UOM</label><div class="custom-combo mt-1"><select class="form-select uom-select">${uomOptions}</select><input type="text" data-item-prop="uom-custom" class="form-input hidden uom-custom"></div></div>
                        <div class="col-span-2" data-doc="invoice"><label class="text-sm">å•ä»· Unit Price</label><input type="number" step="0.00001" data-item-prop="unitPrice" class="form-input mt-1" value="${unitPriceDisplay}"></div>
                        <div class="col-span-2" data-doc="invoice"><label class="text-sm">é‡‘é¢ Amount</label><div class="mt-1 flex flex-wrap items-center gap-2"><input type="number" step="0.00001" data-item-prop="amount" class="form-input w-40" value="${amountDisplay}"><button type="button" class="restore-amount-btn text-sm text-blue-600 hover:text-blue-700 font-medium">æ¢å¤è‡ªåŠ¨é‡‘é¢ Restore</button></div></div>
                    </div>
                </div>
            </div>`;
        D('items-container').insertAdjacentHTML('beforeend', fullItemHtml);
        const rowEl = D(`item-${itemCounter}`);
        const uomSelect = rowEl.querySelector('.uom-select');
        const uomCustom = rowEl.querySelector('.uom-custom');
        const qtyInput = rowEl.querySelector('[data-item-prop="qty"]');
        const unitPriceInput = rowEl.querySelector('[data-item-prop="unitPrice"]');
        const amountInput = rowEl.querySelector('[data-item-prop="amount"]');
        const restoreBtn = rowEl.querySelector('.restore-amount-btn');
        const netWtInput = rowEl.querySelector('[data-item-prop="netWt"]');

        rowEl.dataset.manualAmount = amountMode === 'manual' ? 'true' : 'false';

        const applyAutoAmount = () => {
            const autoAmount = computeItemAmount(qtyInput.value, unitPriceInput.value);
            amountInput.value = (Number.isFinite(autoAmount) ? autoAmount : 0).toFixed(2);
        };

        if (rowEl.dataset.manualAmount === 'true') {
            const parsed = parseAmountValue(amountInput.value);
            if (parsed === null) {
                rowEl.dataset.manualAmount = 'false';
                applyAutoAmount();
            } else {
                amountInput.value = parsed.toFixed(2);
            }
        } else {
            applyAutoAmount();
        }

        const handleAutoFieldChange = () => {
            if (rowEl.dataset.manualAmount !== 'true') {
                applyAutoAmount();
            }
            updateItemsAndTotals();
        };

        if (qtyInput) qtyInput.addEventListener('input', handleAutoFieldChange);
        if (unitPriceInput) unitPriceInput.addEventListener('input', handleAutoFieldChange);
        if (netWtInput) netWtInput.addEventListener('input', updateItemsAndTotals);

        if (amountInput) {
            amountInput.addEventListener('input', () => {
                rowEl.dataset.manualAmount = 'true';
                updateItemsAndTotals();
            });

            amountInput.addEventListener('blur', () => {
                const parsed = parseAmountValue(amountInput.value);
                if (parsed === null) {
                    rowEl.dataset.manualAmount = 'false';
                    applyAutoAmount();
                } else {
                    amountInput.value = parsed.toFixed(2);
                    rowEl.dataset.manualAmount = 'true';
                }
                updateItemsAndTotals();
            });
        }

        if (restoreBtn) {
            restoreBtn.addEventListener('click', () => {
                rowEl.dataset.manualAmount = 'false';
                applyAutoAmount();
                updateItemsAndTotals();
            });
        }

        // Set up UOM select change handler
        uomSelect.addEventListener('change', function() {
            uomCustom.classList.toggle('hidden', this.value !== 'Custom');
            updateAllPreviews();
        });

        if (data.uom && !optionConfigs.uom.options.includes(data.uom)) {
            uomSelect.value = 'Custom';
            uomCustom.value = data.uom;
            uomCustom.classList.remove('hidden');
        } else {
            uomSelect.dispatchEvent(new Event('change'));
        }

        // Update totals after adding item
        updateItemsAndTotals();
    }

    function updateItemsAndTotals() {
        const docType = getDocumentMode();
        const currencySelect = D('currency-select');
        let resolvedCurrency = optionConfigs.currency.default;
        if (currencySelect) {
            if (currencySelect.value === 'Custom') {
                const customCurrencyInput = D('currency-custom');
                resolvedCurrency = customCurrencyInput ? customCurrencyInput.value : '';
            } else {
                resolvedCurrency = currencySelect.value;
            }
        }
        const currencySymbol = getCurrencySymbol(resolvedCurrency);

        if (docType === 'invoice') {
            let totalAmount = 0;
            const itemsBody = D('preview-items-body');
            if (itemsBody) itemsBody.innerHTML = '';
            const packingBody = D('preview-packing-items-body');
            if (packingBody) packingBody.innerHTML = '';
            QA('.item-row').forEach((row, index) => {
                const getVal = (p) => row.querySelector(`[data-item-prop="${p}"]`)?.value || '';
                const uomSelect = row.querySelector('.uom-select');
                const uom = uomSelect.value === 'Custom' ? row.querySelector('.uom-custom').value : uomSelect.value;
                const qty = parseFloat(getVal('qty')) || 0;
                const unitPrice = parseFloat(getVal('unitPrice')) || 0;
                const netWtValue = parseFloat(getVal('netWt')) || 0;
                const amountInput = row.querySelector('[data-item-prop="amount"]');
                let amountValue = parseAmountValue(amountInput ? amountInput.value : null);
                if (amountValue === null) {
                    amountValue = computeItemAmount(qty, unitPrice);
                }
                totalAmount += amountValue;
                if (itemsBody) {
                    itemsBody.insertAdjacentHTML('beforeend', `<tr><td>${index + 1}</td><td><pre class="whitespace-pre-wrap">${getVal('description')}</pre></td><td class="hs-code-cell" data-template="ci-only">${getVal('hs-code')}</td><td class="text-right" data-template="ci-only">${formatWeightValue(netWtValue)}</td><td class="text-center">${formatQuantityValue(qty)}</td><td>${uom}</td><td class="text-right">${formatUnitPriceValue(unitPrice)}</td><td class="text-right">${formatCurrencyValue(amountValue, currencySymbol)}</td></tr>`);
                }
            });

            const totalTarget = Q('[data-target="total-amount"]');
            if (totalTarget) {
                totalTarget.textContent = formatCurrencyValue(totalAmount, currencySymbol);
            }
            ['pl-total-packages', 'pl-total-qty', 'pl-total-net', 'pl-total-gross', 'pl-total-volume'].forEach(id => {
                const el = Q(`[data-target="${id}"]`);
                if (el) el.textContent = '';
            });
        } else {
            let totalPackages = 0;
            let totalGross = 0;
            let totalVolume = 0;
            const packingBody = D('preview-packing-items-body');
            if (packingBody) packingBody.innerHTML = '';

            let totalQty = 0;
            let totalNet = 0;
            const itemsContainer = D('items-container');
            const packageCards = itemsContainer ? itemsContainer.querySelectorAll('.package-card') : [];
            packageCards.forEach((packageCard, pkgIndex) => {
                const packageTypeSelect = packageCard.querySelector('.package-type-select');
                const packageType = packageTypeSelect ? (packageTypeSelect.value === 'Custom' ? packageCard.querySelector('.package-type-custom').value : packageTypeSelect.value) : 'Carton';
                const dimensionsInput = packageCard.querySelector('[data-package-prop="dimensions"]');
                const dimensions = dimensionsInput ? dimensionsInput.value : '';
                const grossWtInput = packageCard.querySelector('[data-package-prop="grossWt"]');
                const grossWt = parseFloat(grossWtInput ? grossWtInput.value : 0) || 0;
                const cbmInput = packageCard.querySelector('[data-package-prop="cbm"]');
                const cbm = parseFloat(cbmInput ? cbmInput.value : 0) || 0;
                const packagesInput = packageCard.querySelector('[data-package-prop="packages"]');
                const packages = parseInt(packagesInput ? packagesInput.value : 1) || 1;

                totalPackages += packages;
                totalGross += grossWt * packages;
                totalVolume += cbm * packages;

                const items = packageCard.querySelectorAll('.package-item');

                // Package header row
                if (packingBody && items.length > 0) {
                    const totalGrossWt = grossWt * packages;
                    const totalCbm = cbm * packages;
                    packingBody.insertAdjacentHTML('beforeend', `<tr class="font-semibold bg-gray-50">
                        <td colspan="2" class="text-left">${packageType} (${formatQuantityValue(packages)} ${packages > 1 ? 'packages' : 'package'})</td>
                        <td></td>
                        <td colspan="2"></td>
                        <td class="text-center">${dimensions || '-'}</td>
                        <td></td>
                        <td class="text-right">${formatWeightValue(totalGrossWt)}</td>
                        <td class="text-right">${formatVolumeValue(totalCbm)}</td>
                    </tr>`);
                }

                // Item rows within the package - reset item numbering for each package
                let itemIndex = 0;
                items.forEach((itemEl, itemIdx) => {
                    itemIndex++;
                    const description = itemEl.querySelector('[data-item-prop="description"]')?.value || '';
                    const hscode = itemEl.querySelector('[data-item-prop="hscode"]')?.value || '';
                    const qty = parseFloat(itemEl.querySelector('[data-item-prop="qty"]')?.value || 0);
                    const netWt = parseFloat(itemEl.querySelector('[data-item-prop="netWt"]')?.value || 0);
                    const uomSelect = itemEl.querySelector('.uom-select');
                    const uom = uomSelect ? (uomSelect.value === 'Custom' ? itemEl.querySelector('.uom-custom').value : uomSelect.value) : 'PCS';

                    totalQty += qty;
                    totalNet += netWt;

                    if (packingBody) {
                        packingBody.insertAdjacentHTML('beforeend', `<tr>
                            <td class="text-right pr-2">${itemIndex}</td>
                            <td><pre class="whitespace-pre-wrap pl-4">${description}</pre></td>
                            <td class="hs-code-cell text-center">${hscode}</td>
                            <td class="text-center">${formatQuantityValue(qty)}</td>
                            <td>${uom}</td>
                            <td></td>
                            <td class="text-right">${formatWeightValue(netWt)}</td>
                            <td></td>
                            <td></td>
                        </tr>`);
                    }
                });
            });

            const setTarget = (id, value) => {
                QA(`[data-target="${id}"]`).forEach(el => {
                    if (el) el.textContent = value;
                });
            };
            setTarget('pl-total-packages', formatQuantityValue(totalPackages));
            setTarget('pl-total-gross', formatWeightValue(totalGross));
            setTarget('pl-total-volume', formatVolumeValue(totalVolume));
            setTarget('pl-total-qty', formatQuantityValue(totalQty));
            setTarget('pl-total-net', formatWeightValue(totalNet));
            const invoiceBody = D('preview-items-body');
            if (invoiceBody) invoiceBody.innerHTML = '';
            const totalTarget = Q('[data-target="total-amount"]');
            if (totalTarget) totalTarget.textContent = '';
        }

        switchTemplate();
    }

    function getCurrencySymbol(currency) {
        const currencySymbols = {
            'USD': '$',
            'RMB': 'Â¥',
            'EUR': 'â‚¬',
            'GBP': 'Â£',
            'JPY': 'Â¥'
        };
        return currencySymbols[currency] || currency + ' ';
    }

    const numberFormatters = {
        amount: new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
        unitPrice: new Intl.NumberFormat('en-US', { minimumFractionDigits: 5, maximumFractionDigits: 5 }),
        quantity: new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 3 }),
        weight: new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
        volume: new Intl.NumberFormat('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 })
    };

    function formatCurrencyValue(amount, symbol) {
        return `${symbol}${numberFormatters.amount.format(amount)}`;
    }

    function formatUnitPriceValue(value) {
        return numberFormatters.unitPrice.format(value);
    }

    function formatQuantityValue(value) {
        return numberFormatters.quantity.format(value);
    }

    function formatWeightValue(value) {
        return numberFormatters.weight.format(value);
    }

    function formatVolumeValue(value) {
        return numberFormatters.volume.format(value);
    }

    function parseAmountValue(value) {
        if (value === null || value === undefined) return null;
        const normalized = String(value).replace(/,/g, '').trim();
        if (!normalized) return null;
        const parsed = parseFloat(normalized);
        return Number.isFinite(parsed) ? parsed : null;
    }

    function computeItemAmount(qtyValue, unitPriceValue) {
        const qty = parseFloat(qtyValue) || 0;
        const unitPrice = parseFloat(unitPriceValue) || 0;
        return qty * unitPrice;
    }





    function buildPrintableInvoiceHtmlDocument(data) {
        const previewElement = D('invoice-preview');
        if (!previewElement) return '';
        const previewClone = previewElement.cloneNode(true);
        previewClone.style.transform = 'none';
        previewClone.style.boxShadow = 'none';
        previewClone.style.margin = '0 auto';
        previewClone.style.minHeight = 'auto';
        previewClone.style.height = 'auto';
        previewClone.style.background = '#ffffff';
        previewClone.style.width = getComputedStyle(previewElement).width || '794px';

        const wrapper = document.createElement('div');
        wrapper.appendChild(previewClone);
        const invoiceMarkup = wrapper.innerHTML;

        const styleEl = document.querySelector('style');
        const baseStyles = styleEl ? styleEl.textContent : '';
        const documentTitle = `${data.invoiceType || 'Invoice'} ${data.fullInvoiceNo || ''}`.trim() || 'Invoice';
        const docType = (data.documentType || 'invoice').toLowerCase();

        const autoPrintScriptCloseGuard = '</scr' + 'ipt>';
        const printableBase = (data.invoiceBaseNo || data.coreId || '').trim();
        const printableRevision = (data.revision || data.version || 'A').trim().toUpperCase();
        const printableFullNumber = printableBase ? `${printableBase}-${printableRevision}` : `Revision ${printableRevision}`;
        const footerMessage = docType === 'packing' ? '' : 'This is a computer-generated invoice and requires no signature.';

        return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>${documentTitle}</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></scr${'ipt'}>
<style>
${baseStyles}
/* PDF-friendly font and text rendering settings */
* {
  font-family: "Microsoft YaHei", "PingFang SC", "Heiti SC", "SimSun", Arial, "Arial Unicode MS", sans-serif !important;
  -webkit-font-smoothing: subpixel-antialiased !important;
  -moz-osx-font-smoothing: auto !important;
  text-rendering: optimizeLegibility !important;
}
body { background: #f3f4f6; padding: 0; display: flex; flex-direction: column; }
.print-wrapper {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  background: #ffffff;
}
#invoice-preview {
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.15) !important;
  transform: none !important;
  margin: 0;
  background: #ffffff;
  flex: 1;
  padding: 68px;
}

/* Print header and footer styles (Safari compatible) */
.print-header {
  display: flex;
  justify-content: space-between;
  padding: 10px 16px;
  font-size: 9px;
  font-weight: 400;
  color: #6b7280;
  background: #ffffff;
  margin-bottom: 0;
}
.print-footer {
  display: flex;
  justify-content: center;
  padding: 10px 16px;
  font-size: 9px;
  color: #6b7280;
  background: #ffffff;
  margin-top: auto;
}
@media screen {
  .print-header, .print-footer { display: flex; }
}

@page {
  size: A4;
  margin: 20mm 20mm 30mm 20mm;
  @top-left {
    content: "${printableFullNumber}";
    font-size: 9px;
    font-weight: 400;
    color: #6b7280;
  }
  @top-right {
    content: "Page " counter(page) " of " counter(pages);
    font-size: 9px;
    font-weight: 400;
    color: #6b7280;
  }
  @bottom-center {
    content: "${footerMessage}";
    font-size: 9px;
    color: #6b7280;
  }
}
@media print {
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    /* PDF-friendly font settings for better text copy-paste */
    font-family: "Microsoft YaHei", "PingFang SC", "Heiti SC", "SimSun", Arial, "Arial Unicode MS", sans-serif !important;
    -webkit-font-smoothing: subpixel-antialiased !important;
    -moz-osx-font-smoothing: auto !important;
    text-rendering: optimizeLegibility !important;
  }
  body {
    background: #ffffff;
    display: block;
  }
  .print-wrapper {
    width: 100%;
    max-width: none;
    margin: 0;
    padding: 0;
    display: block;
    position: relative;
  }
  #invoice-preview {
    box-shadow: none !important;
    transform: none !important;
    margin: 0;
    padding: 20px 40px;
    padding-top: 40px;
    padding-bottom: 60px;
  }
  #invoice-preview h1[data-target="invoice-title"] {
    display: block !important;
    visibility: visible !important;
    color: #1f2937 !important;
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    text-align: center !important;
    margin-bottom: 1.5rem !important;
    background: none !important;
    padding: 0.5rem 0 !important;
    border: none !important;
  }

  /* Keep headers and labels gray - MUST come first */
  #invoice-preview th,
  #invoice-preview .party-info-block h3,
  #invoice-preview .preview-table thead th,
  #invoice-preview strong,
  #invoice-preview tfoot td {
    color: #6b7280 !important;
  }

  /* Make all user-typed content black */
  #invoice-preview td[data-target],
  #invoice-preview span[data-target],
  #invoice-preview pre[data-target],
  #invoice-preview p[data-target] {
    color: #000000 !important;
  }
  #invoice-preview td:not(tfoot td):not(th),
  #invoice-preview .preview-table tbody td {
    color: #000000 !important;
  }

  #invoice-preview tfoot { display: table-row-group; }

  /* Prevent page breaks inside table rows */
  .preview-table tr {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* Keep package headers with their items */
  .preview-table tbody tr {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* Prevent orphaned TOTALS row */
  .preview-table tfoot {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* Prevent breaks after package headers (semibold rows) */
  .preview-table tr.font-semibold {
    page-break-after: avoid;
    break-after: avoid;
  }

  .print-header {
    display: flex !important;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: #ffffff;
    justify-content: space-between;
  }
  .print-footer {
    display: flex !important;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: #ffffff;
    justify-content: center;
  }
}
</style>
</head>
<body>
<div class="print-wrapper">
<div class="print-header">
  <div>${printableFullNumber}</div>
  <div id="page-counter">Page 1</div>
</div>
${invoiceMarkup}
<div class="print-footer">
  <div>${footerMessage}</div>
</div>
</div>
<script>
window.addEventListener('load', function() {
  var preview = document.getElementById('invoice-preview');
  if (preview) {
    preview.style.transform = 'none';
    preview.style.minHeight = 'auto';
    preview.style.height = 'auto';
    preview.style.background = '#ffffff';
  }
  setTimeout(function() { window.print(); }, 300);
});
${autoPrintScriptCloseGuard}
</body>
</html>`;
    }

    
    function populateShipperSelect() { D('shipper-select').innerHTML = Object.keys(shipperProfiles).map(k => `<option value="${k}">${shipperProfiles[k].name}</option>`).join(''); }

    function populateConsigneeSelect() {
        const opts = Object.keys(consigneeProfiles).map(k => `<option value="${k}">${consigneeProfiles[k].name}</option>`).join('');
        D('consignee-select').innerHTML = opts || '<option value="">-- No profiles --</option>';
    }

    function populateBillToSelect() {
        const opts = Object.keys(billToProfiles).map(k => `<option value="${k}">${billToProfiles[k].name}</option>`).join('');
        D('billto-select').innerHTML = opts || '<option value="">-- No profiles --</option>';
    }

    function switchTemplate() {
        const docType = getDocumentMode();
        const invoiceType = getInvoiceType();
        const isCI = invoiceType === 'COMMERCIAL INVOICE';

        QA('[data-doc]').forEach(el => {
            const attr = (el.dataset.doc || '').split(',').map(v => v.trim()).filter(Boolean);
            if (attr.length === 0) return;
            el.style.display = attr.includes(docType) ? '' : 'none';
        });

        QA('[data-template="ci-only"]').forEach(el => {
            const attr = (el.dataset.doc || '').split(',').map(v => v.trim()).filter(Boolean);
            if (attr.length && !attr.includes(docType)) {
                el.style.display = 'none';
                return;
            }
            if (docType === 'packing') {
                el.style.display = '';
                return;
            }
            el.style.display = isCI ? '' : 'none';
        });

        const totalCol = D('total-colspan');
        if (totalCol) {
            totalCol.colSpan = docType === 'invoice' && isCI ? 7 : 5;
        }
    }

    function updateDocumentUI() {
        const docType = getDocumentMode();
        const heading = D('document-details-heading');
        if (heading) {
            heading.textContent = docType === 'invoice' ? 'å‘ç¥¨ä¿¡æ¯ Invoice Details' : 'è£…ç®±å•ä¿¡æ¯ Packing List Details';
        }
        const numberLabel = D('document-number-label');
        if (numberLabel) {
            numberLabel.textContent = docType === 'invoice' ? 'å‘ç¥¨å·ç  Invoice No.' : 'è£…ç®±å•å· Packing List No.';
        }
        const addItemBtn = D('add-item-btn');
        if (addItemBtn) {
            addItemBtn.textContent = docType === 'invoice' ? '+ æ·»åŠ æ–°æ¡ç›® Add Item' : '+ æ·»åŠ æ–°åŒ…è£… Add Package';
        }
        const prefixLabel = D('document-prefix-label');
        if (prefixLabel) {
            const prefix = getDocumentPrefix();
            prefixLabel.textContent = `${prefix}-`;
        }

        // Update body class for visual distinction
        document.body.classList.remove('doc-mode-invoice', 'doc-mode-packing', 'doc-mode-proforma', 'doc-mode-commercial');
        if (docType === 'packing') {
            document.body.classList.add('doc-mode-packing');
        } else if (isProformaInvoice()) {
            document.body.classList.add('doc-mode-proforma');
        } else if (Q('input[name="invoice-type"]:checked')?.value === 'COMMERCIAL INVOICE') {
            document.body.classList.add('doc-mode-commercial');
        } else {
            document.body.classList.add('doc-mode-invoice');
        }
    }

    function handleDocumentModeChange() {
        latestStoredRevision = '';
        currentRevisionLoaded = '';
        lastRenderedRevisionBase = '';
        revisionConfirmed = false;
        setEditingLocked(false);
        invoiceSeqDirty = false;
        invoiceVersionDirty = false;
        lastAutoDocumentSeq = '';
        const docType = getDocumentMode();
        if (docType === 'invoice') {
            syncPaymentDetailsWithShipper({ force: true });
        } else {
            const paymentField = D('payment-details');
            if (paymentField) {
                paymentField.value = '';
                paymentDetailsDirty = false;
            }
            // Refresh invoice list when switching to packing mode
            populateSavedInvoices();
        }
        syncInvoiceDateSegment({ force: true });
        syncInvoiceSequence({ force: true });
        syncInvoiceVersion({ force: true, defaultVersion: 'A' });
        updateDocumentUI();
        updateAllPreviews();
        renderRevisionTable(composeInvoiceParts().base, currentRevisionLoaded);
        updateRevisionIndicator(latestStoredRevision);
        updateNewRevisionButtonState();
        setTimeout(() => autoFitPreview(), 60);
    }

    function collectFormData(options = {}) {
        const finalizeAmounts = Boolean(options.finalizeAmounts);
        const docType = getDocumentMode();
        const data = { items: [], documentType: docType };
        data.invoiceType = docType === 'invoice' ? getInvoiceType() : 'PACKING LIST';
        ['date', 'invoice-seq', 'invoice-version', 'order-no', 'notify-party'].forEach(id => {
            const el = D(id);
            if (!el) return;
            if (id === 'notify-party' && docType === 'packing') {
                data[id] = '';
                return;
            }
            data[id] = el.value;
        });
        data.invoiceDateSegment = D('invoice-date-segment').value.trim().replace(/[^0-9]/g, '').slice(0, 8);
        data.shipper = D('shipper-select').value;
        data.consignee = D('consignee-select').value;
        data.billTo = D('billto-select').value;
        data.paymentDetails = docType === 'invoice' && D('payment-details') ? D('payment-details').value.trim() : '';
        data.paymentTerms = '';
        data.incoterms = '';
        data.countryOfOrigin = '';
        data.currency = '';

        const selectionKeys = docType === 'invoice' ? ['paymentTerms', 'incoterms', 'countryOfOrigin', 'currency'] : ['currency'];
        selectionKeys.forEach(key => {
            const id = key.replace(/([A-Z])/g, "-$1").toLowerCase();
            const select = D(id + '-select');
            if (!select) {
                data[key] = '';
                return;
            }
            data[key] = select.value === 'Custom' ? D(id + '-custom').value : select.value;
        });

        data.packingInvoiceRef = D('packing-invoice-ref') ? D('packing-invoice-ref').value.trim() : '';
        data.packingMarks = D('packing-marks') ? D('packing-marks').value.trim() : '';
        data.packingNotes = D('packing-notes') ? D('packing-notes').value.trim() : '';

        // Collect packages for packing list
        if (docType === 'packing') {
            data.packages = [];
            const itemsContainer = D('items-container');
            const packageCards = itemsContainer ? itemsContainer.querySelectorAll('.package-card') : [];
            packageCards.forEach(packageCard => {
                const packageTypeSelect = packageCard.querySelector('.package-type-select');
                const packageType = packageTypeSelect ? (packageTypeSelect.value === 'Custom' ? packageCard.querySelector('[data-package-prop="packageType-custom"]').value : packageTypeSelect.value) : 'Carton';
                const dimensionsInput = packageCard.querySelector('[data-package-prop="dimensions"]');
                const grossWtInput = packageCard.querySelector('[data-package-prop="grossWt"]');
                const cbmInput = packageCard.querySelector('[data-package-prop="cbm"]');
                const packagesInput = packageCard.querySelector('[data-package-prop="packages"]');

                const packageData = {
                    packageType: packageType,
                    dimensions: dimensionsInput ? dimensionsInput.value : '',
                    grossWt: grossWtInput ? grossWtInput.value : '0',
                    cbm: cbmInput ? cbmInput.value : '0',
                    packages: packagesInput ? parseInt(packagesInput.value) || 1 : 1,
                    items: []
                };

                packageCard.querySelectorAll('.package-item').forEach(itemEl => {
                    const uomSelect = itemEl.querySelector('.uom-select');
                    const uom = uomSelect ? (uomSelect.value === 'Custom' ? itemEl.querySelector('[data-item-prop="uom-custom"]').value : uomSelect.value) : 'PCS';

                    packageData.items.push({
                        description: itemEl.querySelector('[data-item-prop="description"]')?.value || '',
                        hscode: itemEl.querySelector('[data-item-prop="hscode"]')?.value || '',
                        qty: itemEl.querySelector('[data-item-prop="qty"]')?.value || '0',
                        uom: uom,
                        netWt: itemEl.querySelector('[data-item-prop="netWt"]')?.value || '0'
                    });
                });

                data.packages.push(packageData);
            });
        }

        QA('.item-row').forEach(row => {
            const uomSelect = row.querySelector('.uom-select');
            const qtyInput = row.querySelector('[data-item-prop="qty"]');
            const unitPriceInput = row.querySelector('[data-item-prop="unitPrice"]');
            const amountInput = row.querySelector('[data-item-prop="amount"]');
            const netWtInput = row.querySelector('[data-item-prop="netWt"]');
            const qtyValue = qtyInput ? qtyInput.value : '0';
            const unitPriceValue = unitPriceInput ? unitPriceInput.value : '0';
            const manualRequested = row.dataset.manualAmount === 'true';
            const parsedAmount = amountInput ? parseAmountValue(amountInput.value) : null;
            let useManual = manualRequested && parsedAmount !== null;
            let resolvedAmount = useManual ? parsedAmount : computeItemAmount(qtyValue, unitPriceValue);
            if (!Number.isFinite(resolvedAmount)) {
                resolvedAmount = 0;
            }

            if (finalizeAmounts) {
                if (useManual) {
                    if (amountInput) amountInput.value = parsedAmount.toFixed(2);
                    row.dataset.manualAmount = 'true';
                } else {
                    row.dataset.manualAmount = 'false';
                    if (amountInput) amountInput.value = resolvedAmount.toFixed(2);
                }
            }

            data.items.push({
                description: row.querySelector('[data-item-prop="description"]').value,
                'hs-code': row.querySelector('[data-item-prop="hs-code"]').value,
                qty: qtyValue,
                uom: uomSelect.value === 'Custom' ? row.querySelector('[data-item-prop="uom-custom"]').value : uomSelect.value,
                netWt: netWtInput ? netWtInput.value : '0',
                unitPrice: unitPriceValue,
                amount: resolvedAmount.toFixed(2),
                amountMode: useManual ? 'manual' : 'auto'
            });
        });

        const invoiceParts = composeInvoiceParts();
        data.coreId = invoiceParts.base;
        data.revision = invoiceParts.version || 'A';
        data.version = data.revision;
        data.fullInvoiceNo = invoiceParts.full;
        data.invoiceBaseNo = invoiceParts.base;
        return data;
    }

    function populateFormWithData(data, options = {}) {
        if (!data) return;
        const inferredDocType = (data.documentType || (data.invoiceType === 'PACKING LIST' ? 'packing' : 'invoice')).toLowerCase();
        const modeRadio = Q(`input[name="document-mode"][value="${inferredDocType}"]`);
        if (modeRadio) modeRadio.checked = true;
        if (inferredDocType === 'invoice' && data.invoiceType) {
            const invoiceRadio = Q(`input[name="invoice-type"][value="${data.invoiceType}"]`) || Q('input[name="invoice-type"]');
            if (invoiceRadio) invoiceRadio.checked = true;
        }
        data.revision = (data.revision || data.version || 'A').trim().toUpperCase();
        data.version = data.revision;
        ['date', 'invoice-seq', 'invoice-version', 'order-no', 'notify-party'].forEach(id => {
            const el = D(id);
            if (!el) return;
            if (id === 'notify-party' && inferredDocType === 'packing') {
                el.value = '';
                return;
            }
            el.value = data[id] || '';
        });
        if (data.consignee) D('consignee-select').value = data.consignee;
        if (data.billTo) D('billto-select').value = data.billTo;
        const segmentInput = D('invoice-date-segment');
        if (segmentInput) {
            const defaultSegment = generateInvoiceDateSegment(data.date);
            const resolvedSegment = ((data.invoiceDateSegment || '').trim().replace(/[^0-9]/g, '') || defaultSegment).slice(0, 8);
            segmentInput.value = resolvedSegment || '';
            lastAutoInvoiceSegment = defaultSegment || '';
            invoiceDateSegmentDirty = resolvedSegment !== defaultSegment;
        }
        const paymentField = D('payment-details');
        if (paymentField) {
            const defaultDetails = getDefaultPaymentDetails(data.shipper);
            if (inferredDocType === 'invoice') {
                const resolvedDetails = (data.paymentDetails || '').trim() || defaultDetails;
                paymentField.value = resolvedDetails;
                lastAutoPaymentDetails = defaultDetails || '';
                paymentDetailsDirty = resolvedDetails !== defaultDetails;
            } else {
                paymentField.value = '';
                lastAutoPaymentDetails = defaultDetails || '';
                paymentDetailsDirty = false;
            }
        }
        D('shipper-select').value = data.shipper;
        D('shipper-select').dispatchEvent(new Event('change'));

        data.invoiceBaseNo = data.invoiceBaseNo || composeInvoiceParts().base;

        const selectionKeys = inferredDocType === 'invoice' ? ['paymentTerms', 'incoterms', 'countryOfOrigin', 'currency'] : ['currency'];
        selectionKeys.forEach(key => {
            const id = key.replace(/([A-Z])/g, "-$1").toLowerCase();
            const select = D(id + '-select');
            if (!select) return;
            if (select.querySelector(`option[value="${data[key]}"]`)) {
                select.value = data[key];
            } else {
                select.value = 'Custom';
                D(id + '-custom').value = data[key];
            }
            select.dispatchEvent(new Event('change'));
        });
        if (inferredDocType === 'invoice') {
            ['paymentTerms', 'incoterms', 'countryOfOrigin'].forEach(key => {
                if (!selectionKeys.includes(key)) {
                    const id = key.replace(/([A-Z])/g, "-$1").toLowerCase();
                    const select = D(id + '-select');
                    if (select) select.dispatchEvent(new Event('change'));
                }
            });
        }

        if (D('packing-invoice-ref')) D('packing-invoice-ref').value = data.packingInvoiceRef || '';
        if (D('packing-marks')) D('packing-marks').value = data.packingMarks || '';
        if (D('packing-notes')) D('packing-notes').value = data.packingNotes || '';

        D('items-container').innerHTML = '';
        itemCounter = 0;
        packageCounter = 0;

        if (inferredDocType === 'packing' && data.packages && Array.isArray(data.packages)) {
            data.packages.forEach(pkg => addNewPackage(pkg));
        } else if (data.items) {
            data.items.forEach(item => addNewItem(item));
        }

        const seqInput = D('invoice-seq');
        if (seqInput) {
                lastAutoDocumentSeq = seqInput.value.trim();
            invoiceSeqDirty = true;
        }

        const versionInput = D('invoice-version');
        const storedRevision = (data.version || data.revision || '').trim().toUpperCase();
        if (options.latestRevision) {
            latestStoredRevision = options.latestRevision;
        } else if (storedRevision) {
            latestStoredRevision = storedRevision;
        }
        const autoIncrementRevision = options.autoIncrementRevision !== false;
        currentRevisionLoaded = options.selectedRevision || storedRevision || '';
        const shouldLock = Boolean(options.selectedRevision && options.autoIncrementRevision === false);
        setEditingLocked(shouldLock);
        if (versionInput) {
            if (autoIncrementRevision) {
                const nextRevision = getNextVersionLetter(storedRevision || versionInput.value);
                versionInput.value = nextRevision;
                lastAutoInvoiceVersion = nextRevision;
                invoiceVersionDirty = false;
            } else {
                const displayRevision = storedRevision || versionInput.value || 'A';
                versionInput.value = displayRevision;
                lastAutoInvoiceVersion = displayRevision;
                invoiceVersionDirty = false;
            }
        }

        renderRevisionTable(data.invoiceBaseNo, currentRevisionLoaded);
        updateRevisionIndicator(latestStoredRevision);
        updateAllPreviews();
    }

    function checkAndLoadVersion() {
        const coreId = getCurrentCoreId();
        if (!coreId) return;
        const versions = storage.getDocument(coreId, getDocumentMode());
        if (versions) {
            const latestVersion = Object.keys(versions).sort().pop();
            latestStoredRevision = latestVersion || 'A';
            populateFormWithData(versions[latestVersion], { latestRevision: latestStoredRevision, selectedRevision: latestVersion, autoIncrementRevision: false });
            showToast(`å·²åŠ è½½å†å²ä¿®è®¢ Revision ${latestVersion}`);
        } else {
            latestStoredRevision = '';
            setEditingLocked(false);
            updateRevisionIndicator(latestStoredRevision);
            updateNewRevisionButtonState();
        }
    }

    function showToast(message) {
        const toast = D('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showDownloadPrep() {
        const prepElement = D('download-prep');
        prepElement.classList.add('show');
    }

    function hideDownloadPrep() {
        const prepElement = D('download-prep');
        prepElement.classList.remove('show');
    }

    function initialize() {
        shipperProfiles = storage.getShippers();
        consigneeProfiles = storage.getConsignees();
        billToProfiles = storage.getBillTo();
        profileManager.init();
        consigneeManager.init();
        billToManager.init();
        populateShipperSelect();
        populateConsigneeSelect();
        populateBillToSelect();
        populateSavedInvoices();
        Object.keys(optionConfigs).forEach(key => {
            if(key !== 'uom') {
                createSelectWithOptions(key.replace(/([A-Z])/g, "-$1").toLowerCase(), optionConfigs[key]);
            }
        });

        D('date').value = formatDate(new Date());
        syncInvoiceDateSegment({ force: true });
        syncInvoiceSequence({ force: true });
        syncInvoiceVersion({ force: true, defaultVersion: 'A' });
        D('shipper-select').value = Object.keys(shipperProfiles)[0] || '';
        D('consignee-select').value = Object.keys(consigneeProfiles)[0] || '';
        D('billto-select').value = Object.keys(billToProfiles)[0] || '';

        D('notify-party').value = '';
        D('order-no').value = String(Date.now()).slice(-9);
        if (syncPaymentDetailsWithShipper({ force: true })) {
            lastAutoPaymentDetails = D('payment-details').value;
        } else {
            D('payment-details').value = getDefaultPaymentDetails(D('shipper-select').value) || '';
            lastAutoPaymentDetails = D('payment-details').value;
        }
        addNewItem({ description: 'Premium Electronic Components\nHigh-quality circuit boards for industrial use\nSpecification: 25mm x 15mm, Grade A', 'hs-code': '8541.90.00', qty: 1000, uom: 'PCS', netWt: 5.50, unitPrice: 2.45 });

        latestStoredRevision = '';
        setEditingLocked(false);
        updateRevisionIndicator(latestStoredRevision);

        D('shipper-select').dispatchEvent(new Event('change'));
        updateDocumentUI();
        updateAllPreviews();
        updateNewRevisionButtonState();
        renderRevisionTable(composeInvoiceParts().base, currentRevisionLoaded);

        // Delay autoFitPreview to ensure DOM is fully rendered
        setTimeout(() => {
            autoFitPreview();
        }, 100);
    }

    // --- EVENT LISTENERS ---
    QA('input[name="document-mode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            handleDocumentModeChange();
        });
    });
    QA('input[name="invoice-type"]').forEach(radio => {
        radio.addEventListener('change', () => {
            updateDocumentUI();
            syncInvoiceSequence({ force: true });
            syncInvoiceVersion({ force: true, defaultVersion: 'A' });
            checkAndLoadVersion();
            updateAllPreviews();
        });
    });
    window.addEventListener('resize', autoFitPreview);
    D('form-container').addEventListener('input', updateAllPreviews);
    
    D('date').addEventListener('change', () => {
        syncInvoiceDateSegment();
        syncInvoiceSequence({ force: true });
        syncInvoiceVersion({ force: true, defaultVersion: 'A' });
        checkAndLoadVersion();
        updateAllPreviews();
    });
    D('invoice-seq').addEventListener('change', () => {
        checkAndLoadVersion();
        updateAllPreviews();
    });
    
    D('items-container').addEventListener('click', e => {
        if (e.target.classList.contains('remove-item-btn')) {
            e.target.closest('.item-row').remove();
            QA('.item-row').forEach((row, i) => row.querySelector('p').textContent = `æ¡ç›® #${i + 1}`);
            updateItemsAndTotals();
        }
        if (e.target.classList.contains('remove-package-btn')) {
            e.target.closest('.package-card').remove();
            let pkgNum = 1;
            D('items-container').querySelectorAll('.package-card').forEach(card => {
                card.querySelector('p').textContent = `ğŸ“¦ åŒ…è£… Package #${pkgNum}`;
                pkgNum++;
            });
            updateItemsAndTotals();
        }
        if (e.target.classList.contains('remove-package-item-btn')) {
            e.target.closest('.package-item').remove();
            updateAllPreviews();
        }
    });
    D('items-container').addEventListener('change', e => {
        if (e.target.classList.contains('uom-select')) {
            e.target.nextElementSibling.classList.toggle('hidden', e.target.value !== 'Custom');
            updateAllPreviews();
        }
    });

    D('add-item-btn').addEventListener('click', () => {
        if (getDocumentMode() === 'packing') {
            addNewPackage();
        } else {
            addNewItem();
        }
    });

    const invoiceDateSegmentInput = D('invoice-date-segment');
    if (invoiceDateSegmentInput) {
        invoiceDateSegmentInput.addEventListener('input', () => {
            invoiceDateSegmentInput.value = invoiceDateSegmentInput.value.replace(/[^0-9]/g, '').slice(0, 8);
            invoiceDateSegmentDirty = invoiceDateSegmentInput.value.trim() !== lastAutoInvoiceSegment;
            updateAllPreviews();
        });
        invoiceDateSegmentInput.addEventListener('blur', () => {
            if (!invoiceDateSegmentInput.value.trim()) {
                if (syncInvoiceDateSegment({ force: true })) {
                    syncInvoiceSequence({ force: true });
                    syncInvoiceVersion({ force: true, defaultVersion: 'A' });
                    updateAllPreviews();
                }
            } else {
                syncInvoiceSequence({ force: false });
                updateAllPreviews();
            }
        });
    }

    const invoiceSeqInput = D('invoice-seq');
    if (invoiceSeqInput) {
        invoiceSeqInput.addEventListener('input', () => {
            invoiceSeqDirty = true;
            updateAllPreviews();
        });
        invoiceSeqInput.addEventListener('blur', () => {
            const raw = invoiceSeqInput.value.trim();
            if (!raw) {
                if (syncInvoiceSequence({ force: true })) {
                    updateAllPreviews();
                }
            } else if (/^\d+$/.test(raw)) {
                const normalized = String(parseInt(raw, 10)).padStart(2, '0');
                if (invoiceSeqInput.value !== normalized) {
                    invoiceSeqInput.value = normalized;
                    updateAllPreviews();
                }
                lastAutoDocumentSeq = normalized;
                const segment = D('invoice-date-segment').value.trim().slice(0, 8);
                if (segment) {
                    const seqKeyPrefix = getSequenceKeyPrefix();
                    localStorage.setItem(`${seqKeyPrefix}${segment}`, String(parseInt(normalized, 10)));
                }
                latestStoredRevision = '';
                updateRevisionIndicator(latestStoredRevision);
            }
        });
    }

    const invoiceVersionInput = D('invoice-version');
    if (invoiceVersionInput) {
        const enforceUppercase = () => {
            invoiceVersionInput.value = (invoiceVersionInput.value || '').toUpperCase();
        };
        invoiceVersionInput.addEventListener('input', () => {
            enforceUppercase();
            invoiceVersionDirty = true;
            updateAllPreviews();
        });
        invoiceVersionInput.addEventListener('blur', () => {
            enforceUppercase();
            if (!invoiceVersionInput.value.trim()) {
                syncInvoiceVersion({ force: true, defaultVersion: 'A' });
                updateAllPreviews();
            }
        });
    }

    const paymentDetailsField = D('payment-details');
    if (paymentDetailsField) {
        paymentDetailsField.addEventListener('input', () => {
            paymentDetailsDirty = paymentDetailsField.value !== lastAutoPaymentDetails;
        });
    }

    const revisionTableBody = D('revision-table-body');
    if (revisionTableBody) {
        revisionTableBody.addEventListener('click', (event) => {
            const deleteBtn = event.target.closest('button[data-revision-delete]');
            const base = revisionTableBody.dataset.base || composeInvoiceParts().base;
            if (deleteBtn) {
                const revisionKey = deleteBtn.dataset.revisionDelete;
                if (!revisionKey || !base) return;
                const message = `ç¡®å®šè¦åˆ é™¤ä¿®è®¢ ${revisionKey} å—ï¼Ÿ\nAre you sure you want to delete revision ${revisionKey}?`;
                if (!confirm(message)) return;
                const remaining = deleteStoredRevision(base, revisionKey);
                if (!remaining || Object.keys(remaining).length === 0) {
                    latestStoredRevision = '';
                    currentRevisionLoaded = '';
                    renderRevisionTable(base, '');
                    syncInvoiceVersion({ force: true, defaultVersion: 'A' });
                    updateRevisionIndicator(latestStoredRevision);
                    updateAllPreviews();
                    return;
                }
                const remainingKeys = Object.keys(remaining).sort();
                latestStoredRevision = remainingKeys[remainingKeys.length - 1] || '';
                if (currentRevisionLoaded === revisionKey) {
                    const fallbackRev = remainingKeys.includes(latestStoredRevision) ? latestStoredRevision : remainingKeys[remainingKeys.length - 1];
                    loadRevisionFromStorage(base, fallbackRev, { autoIncrement: false });
                    currentRevisionLoaded = fallbackRev;
                }
                renderRevisionTable(base, currentRevisionLoaded || latestStoredRevision);
                updateAllPreviews();
                return;
            }

            const row = event.target.closest('tr[data-revision]');
            if (!row) return;
            const revisionKey = row.dataset.revision;
            if (!revisionKey || !base) return;
            if (!loadRevisionFromStorage(base, revisionKey, { autoIncrement: false })) return;
        });
    }

    if (newRevisionBtn) {
        newRevisionBtn.addEventListener('click', () => {
            startNewRevision();
            updateNewRevisionButtonState();
        });
    }

    if (confirmRevisionBtn) {
        confirmRevisionBtn.addEventListener('click', confirmActiveRevision);
    }

    const shipperSelect = D('shipper-select');
    if (shipperSelect) {
        shipperSelect.addEventListener('change', () => {
            if (syncPaymentDetailsWithShipper()) {
                updateAllPreviews();
            } else {
                updateAllPreviews();
            }
        });
    }

    const consigneeSelect = D('consignee-select');
    if (consigneeSelect) {
        consigneeSelect.addEventListener('change', () => {
            updateAllPreviews();
        });
    }

    const billToSelect = D('billto-select');
    if (billToSelect) {
        billToSelect.addEventListener('change', () => {
            updateAllPreviews();
        });
    }

    D('open-printable-html-btn').addEventListener('click', function() {
        const btn = this;
        const btnText = D('html-btn-text');
        const btnLoader = D('html-btn-loader');

        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');

        try {
            const data = collectFormData({ finalizeAmounts: true });
            storage.saveDocument(data);
            latestStoredRevision = data.version || 'A';
            currentRevisionLoaded = latestStoredRevision;
            renderRevisionTable(data.invoiceBaseNo, currentRevisionLoaded);
            updateRevisionIndicator(latestStoredRevision);
            setEditingLocked(true);
            updateAllPreviews();
            // Refresh saved invoices list for packing list reference
            if (data.documentType === 'invoice') {
                populateSavedInvoices();
            }
            const printableHtml = buildPrintableInvoiceHtmlDocument(data);
            if (!printableHtml) {
                throw new Error('Printable HTML template empty');
            }

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showToast('è¯·å…è®¸æµè§ˆå™¨å¼¹å‡ºçª—å£ä»¥æ‰“å¼€æ‰“å°è§†å›¾ / Please allow popups to open print view');
                return;
            }
            showDownloadPrep();
            printWindow.document.open();
            printWindow.document.write(printableHtml);
            printWindow.document.close();

            // Set document title for PDF filename
            const documentTitle = `${data.invoiceType || 'Invoice'} ${data.fullInvoiceNo || ''}`.trim() || 'Invoice';
            printWindow.document.title = documentTitle;

            setTimeout(() => hideDownloadPrep(), 800);
        } catch (error) {
            console.error('Printable HTML generation error:', error);
            showToast('æ‰“å°è§†å›¾ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            hideDownloadPrep();
        } finally {
            btn.disabled = false;
            btnText.classList.remove('hidden');
            btnLoader.classList.add('hidden');
        }
    });

    initialize();
});
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then((registration) => {
        console.log('ServiceWorker registered:', registration.scope);
      })
      .catch((error) => {
        console.log('ServiceWorker registration failed:', error);
      });
  });
}
</script>
</body>
</html>
